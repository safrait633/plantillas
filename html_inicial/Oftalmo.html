<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Oftalmol√≥gico - Algoritmo de Evaluaci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variables CSS para una paleta de colores consistente y modo oscuro */
        :root {
            --primary-color: #3498db; /* Un azul para oftalmo */
            --primary-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --secondary-color: #27ae60; /* Verde para √©xito/normalidad */
            --secondary-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --alert-color: #e74c3c; /* Rojo para alertas */
            --warning-color: #f39c12; /* Naranja para advertencias */
            --info-color: #8e44ad; /* Un morado para elementos de informaci√≥n (ej., Pupil Assessment) */
            --light-bg: #f8f9fa; /* Fondo claro general */
            --card-bg: #ffffff; /* Fondo de tarjetas/contenedores en modo claro */
            --dark-bg: #1a1a1a; /* Fondo oscuro general */
            --dark-card: #3d3d3d; /* Fondo de tarjetas/contenedores en modo oscuro */
            --text-color: #2c3e50; /* Color de texto predeterminado */
            --light-text-color: #ffffff; /* Color de texto para fondos oscuros */
            --border-color: #e1e8ed; /* Color de borde predeterminado */
            --primary-color-rgb: 52, 152, 219; /* Componentes RGB del color primario para sombras */
        }

        /* Estilos para el modo oscuro */
        [data-theme="dark"] {
            --light-bg: var(--dark-bg);
            --card-bg: var(--dark-card);
            --text-color: var(--light-text-color);
            --border-color: #555;
            --primary-gradient: linear-gradient(135deg, #2980b9 0%, #3498db 100%); /* Invertir degradado o ajustar para contraste */
            --secondary-gradient: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            --alert-gradient: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            --warning-gradient: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding-top: 160px; /* Espacio para el dashboard fijo */
            background-color: var(--light-bg);
            line-height: 1.6;
            color: var(--text-color); /* Usar variable de color de texto */
            transition: all 0.3s ease;
        }
        
        /* üåô TOGGLE DE TEMA */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        /* üè† BOT√ìN HOME */
        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary-gradient); /* Usar secondary para Home */
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            transition: all 0.3s ease;
        }
        .home-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        /* üé™ DASHBOARD SUPERIOR FIJO */
        .dashboard-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-gradient);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dashboard-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Ajustado para m√°s items */
            gap: 12px;
            margin-bottom: 10px;
        }

        .dashboard-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            color: white;
            text-align: center;
            font-size: 12px;
        }

        .dashboard-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .dashboard-item i {
            font-size: 16px;
            margin-bottom: 4px;
            display: block;
        }

        .dashboard-alert {
            color: var(--alert-color) !important;
            animation: pulse 2s infinite;
        }

        .dashboard-warning {
            color: var(--warning-color) !important;
        }

        .dashboard-normal {
            color: var(--secondary-color) !important; /* Usar secondary-color para normal */
        }

        /* üéõÔ∏è CONTROLES SUPERIORES */
        .control-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); /* Sombra basada en primary-color */
        }

        .btn-primary { background: var(--primary-gradient); }
        .btn-success { background: var(--secondary-gradient); }
        .btn-warning { background: var(--warning-gradient); }
        .btn-danger { background: var(--alert-gradient); }


        /* üéØ PANEL LATERAL DE NAVEGACI√ìN */
        .nav-panel {
            position: fixed;
            left: 20px;
            top: 160px;
            width: 250px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            z-index: 998;
            transform: translateX(-280px); /* Inicialmente fuera de vista */
            transition: transform 0.3s ease;
        }

        .nav-panel.open {
            transform: translateX(0);
        }

        .nav-panel h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 16px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.1); /* Ligero hover con color primario */
        }

        .nav-item.completed {
            background: rgba(40, 167, 69, 0.1); /* Fondo verde claro para completado */
            color: var(--secondary-color);
        }

        .nav-item.completed i {
            color: var(--secondary-color);
        }

        .nav-item i {
            width: 16px;
            text-align: center;
        }

        /* üìä PANEL LATERAL STICKY - FUNCIONALIDAD PRINCIPAL */
        .sticky-panel {
            position: fixed;
            top: 160px;
            right: -420px; /* Fuera de pantalla por defecto */
            width: 400px;
            height: calc(100vh - 180px);
            background: var(--card-bg);
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 997;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
            border: 2px solid var(--primary-color);
        }

        .sticky-panel.active {
            right: 0;
        }

        .sticky-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }

        .sticky-controls {
            display: flex;
            gap: 8px;
        }

        .sticky-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sticky-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .sticky-content {
            padding: 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            background: var(--light-bg);
            color: var(--text-color);
        }

        .update-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-gradient);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 10;
        }

        .update-indicator.active {
            display: flex;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notificaci√≥n de copia */
        .copy-notification {
            position: fixed;
            top: 200px;
            right: 20px;
            background: var(--secondary-color); /* Color de √©xito */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Ajustar contenido principal cuando paneles est√°n activos */
        .split-view-nav-active .main-container {
            margin-left: 290px;
            transition: margin-left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .split-view-sticky-active .main-container {
            margin-right: 420px;
            transition: margin-right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        /* Cuando ambos est√°n activos */
        .split-view-nav-active.split-view-sticky-active .main-container {
             margin-left: 290px;
             margin-right: 420px;
        }


        .main-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 0 20px; /* Margen por defecto */
            transition: all 0.3s ease;
        }
        
        h1 {
            color: var(--primary-color); /* Usar variable de color */
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid var(--primary-color); /* Usar variable de color */
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* ‚úÖ SECCIONES MEJORADAS */
        .section {
            margin-bottom: 25px;
            border: 2px solid var(--border-color); /* Usar variable de color de borde */
            border-radius: 12px; /* M√°s redondeado */
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--card-bg); /* Fondo de la tarjeta */
        }
        
        .section.active {
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.15); /* Sombra m√°s din√°mica */
        }
        
        .section-header {
            background: var(--primary-gradient); /* Degradado primario */
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease; /* Transici√≥n para hover */
        }
        
        .section-header:hover {
            box-shadow: inset 0 0 20px rgba(255,255,255,0.1); /* Efecto de luz interior en hover */
        }
        
        .section-header .arrow {
            transition: transform 0.3s ease;
            font-size: 18px;
        }
        
        .section-header.expanded .arrow {
            transform: rotate(180deg);
        }

        .section-header .completion-badge {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }

        .section-header .completion-badge.completed {
            background: var(--secondary-color); /* Fondo verde para completado */
        }
        
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            background: var(--light-bg); /* Fondo de contenido de secci√≥n */
            color: var(--text-color);
        }
        
        .section-content.expanded {
            padding: 20px;
        }

        /* Animaci√≥n de entrada de contenido */
        .section-content.expanded .slide-in {
            animation: slideIn 0.3s ease forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* üìã CONTENEDORES DE EXAMEN MEJORADOS */
        .exam-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease; /* Transici√≥n para hover */
        }

        .exam-container:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .exam-header {
            font-size: 18px;
            font-weight: 600;
            background: var(--primary-gradient); /* Degradado primario */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: -20px -20px 15px -20px; /* Margen para superponerse */
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .exam-section {
            background: var(--light-bg); /* Fondo ligero para sub-secciones */
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .exam-section h4 {
            color: var(--text-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-header {
            color: var(--primary-color);
            margin: 15px 0 8px 0;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ‚úÖ GRID DE CHECKBOXES MEJORADO */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px; /* M√°s padding */
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(52, 152, 219, 0.05); /* Ligero hover con color primario */
        }
        
        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: 16px;
            height: 16px;
            margin: 0;
            accent-color: var(--secondary-color); /* Color de acento para checkboxes */
        }
        
        .checkbox-item label {
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .checkbox-item input:checked + label {
            color: var(--secondary-color); /* Color de texto cuando marcado */
            font-weight: 500;
        }
        
        /* üé® ELEMENTOS VISUALES DISTINTIVOS */
        .measurement {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .measurement label {
            font-size: 12px;
            color: #5d6d7e;
            flex-basis: 120px;
            flex-shrink: 0;
        }
        
        .input-field {
            width: 80px;
            padding: 6px 10px; /* M√°s padding */
            border: 2px solid var(--border-color); /* Borde m√°s pronunciado */
            border-radius: 6px; /* M√°s redondeado */
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: var(--card-bg); /* Asegura que se vea bien en modo oscuro */
            color: var(--text-color);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1); /* Sombra al enfocar */
        }

        .bilateral-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        
        .side-container {
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* M√°s redondeado */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); /* Sombra sutil */
            transition: all 0.3s ease;
        }
        .side-container:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        
        .side-header {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary-color); /* Usar color primario */
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 2px solid var(--primary-color); /* Borde m√°s grueso y con color */
            padding-bottom: 8px;
        }

        .visual-acuity {
            background: #e8f4fd; /* Fondo suave para AV */
            border: 1px solid var(--primary-color);
            border-radius: 8px; /* M√°s redondeado */
            padding: 15px;
            margin-top: 15px;
        }

        .visual-acuity h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .acuity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .acuity-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: var(--light-bg); /* Fondo m√°s claro */
            border-radius: 6px; /* M√°s redondeado */
            border: 1px solid var(--border-color);
        }

        .acuity-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-color); /* Color de texto general */
        }

        .acuity-input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .acuity-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
        }

        .pressure-section {
            background: #fff5f5; /* Fondo suave para presi√≥n */
            border: 1px solid var(--alert-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        /* Clases para estados de PIO */
        .score-calculation.pio-normal { border-color: var(--secondary-color); background: #e8f5e8; }
        .score-calculation.pio-borderline { border-color: var(--warning-color); background: #fff8e1; }
        .score-calculation.pio-elevated { border-color: var(--alert-color); background: #fdf2f2; }
        .score-calculation.pio-very-elevated { border-color: #c0392b; background: #fae4e4; }

        .pressure-section h4 {
            color: var(--alert-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .severity-section {
            background: #fdf2f2;
            border: 1px solid var(--alert-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .severity-section h4 {
            color: var(--alert-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .severity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .severity-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px;
        }

        .severity-item input[type="radio"] {
            width: 14px;
            height: 14px;
            accent-color: var(--alert-color); /* Color de acento para radios de severidad */
        }

        .severity-item label {
            font-size: 12px;
            color: var(--text-color); /* Color de texto general */
            cursor: pointer;
        }
        
        .test-results {
            margin-top: 10px;
        }
        
        .test-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 8px 12px; /* M√°s padding */
            margin: 4px 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px; /* M√°s redondeado */
            transition: all 0.3s ease;
        }
        .test-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.1);
        }
        
        .test-item label {
            font-size: 12px;
            color: var(--text-color);
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .test-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .test-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .test-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color); /* Color de acento */
        }
        
        .test-checkbox span {
            font-size: 12px; /* Un poco m√°s grande */
            font-weight: 600; /* Negrita */
        }
        
        .positive { color: var(--alert-color) !important; }
        .negative { color: var(--secondary-color) !important; } /* Usar verde para negativo/normal */
        
        .pupil-assessment {
            background: #fff8e1; /* Fondo suave para pupilas */
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .pupil-assessment h4 {
            color: var(--warning-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .pupil-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .pupil-eye {
            padding: 10px;
            background: var(--light-bg); /* Fondo m√°s claro */
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .pupil-eye h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: var(--warning-color); /* Color de warning */
            text-align: center;
            font-weight: 600;
        }

        .fundoscopy-section {
            background: #f3e5f5; /* Fondo suave para fundoscop√≠a */
            border: 1px solid var(--info-color); /* Usar color info */
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .fundoscopy-section h4 {
            color: var(--info-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .conclusion {
            margin-top: 30px;
            padding: 25px; /* M√°s padding */
            background: var(--card-bg);
            border-radius: 12px; /* M√°s redondeado */
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .conclusion::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient); /* Barra superior con degradado */
        }
        
        .conclusion h3 {
            color: var(--text-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .conclusion-text {
            padding: 20px; /* M√°s padding */
            background: var(--light-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            min-height: 200px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.5; /* Mayor interlineado */
            color: var(--text-color);
        }

        .control-buttons {
            margin-top: 25px; /* M√°s margen superior */
            display: flex;
            gap: 12px; /* Mayor espacio entre botones */
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px; /* M√°s padding */
            border: none;
            border-radius: 8px; /* M√°s redondeado */
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease; /* Transici√≥n para hover */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .vision-color { background-color: var(--primary-color); } /* Adaptado a variables */
        .external-color { background-color: #e67e22; } /* O elige un color de tu paleta */
        .fundus-color { background-color: var(--info-color); }
        .pressure-color { background-color: var(--alert-color); }

        .description-area {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .score-calculation {
            background: #e8f5e8;
            border: 1px solid var(--secondary-color); /* Usar color secundario */
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }

        .score-value {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .field-defect {
            background: #e1f5fe;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .field-defect h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .field-quadrant {
            padding: 8px 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px; /* M√°s redondeado */
            background: var(--light-bg);
            text-align: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .field-quadrant.defect {
            background: var(--alert-color); /* Rojo para defecto */
            border-color: var(--alert-color);
            color: white; /* Texto blanco en fondo rojo */
            transform: scale(1.05); /* Peque√±o efecto al seleccionar */
        }
        .field-quadrant:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            transform: translateY(-2px);
        }

        .visual-field-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Auto-fit para responsividad */
            gap: 20px;
            margin-top: 15px;
        }

        .eye-field {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .eye-field h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            color: var(--primary-color);
        }

        .color-vision {
            background: #fff3e0;
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .color-vision h4 {
            color: var(--warning-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* üì± RESPONSIVIDAD MEJORADA */
        @media (max-width: 1200px) {
            .sticky-panel {
                width: 350px;
            }
            .split-view-sticky-active .main-container {
                margin-right: 370px;
            }
        }

        @media (max-width: 768px) {
            body { padding-top: 120px; } /* Ajuste para el dashboard en pantallas peque√±as */
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-bar {
                position: relative;
                top: auto;
                right: auto;
                justify-content: center;
                margin: 10px 0;
            }
            
            .nav-panel {
                transform: translateX(-100%); /* Ocultar completamente */
                width: calc(100vw - 40px); /* Ocupar casi todo el ancho */
                left: 20px; /* Asegurar que no haya margen extra */
            }
            .nav-panel.open {
                transform: translateX(0);
            }
            .split-view-nav-active .main-container {
                margin-left: 20px; /* Quitar margen extra si el panel est√° encima */
            }
            
            .main-container {
                margin: 0 10px;
            }
            
            .sticky-panel {
                width: calc(100vw - 20px);
                right: -100vw; /* Fuera de pantalla */
                left: 10px; /* Posicionar desde la izquierda */
                border-radius: 12px; /* Redondear bordes si est√° solo */
            }
            .sticky-panel.active {
                right: auto;
                left: 10px;
            }
            .split-view-sticky-active .main-container {
                margin-right: 10px; /* Quitar margen extra */
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            .bilateral-container {
                grid-template-columns: 1fr; /* Una columna en pantallas peque√±as */
            }
            .visual-field-map {
                grid-template-columns: 1fr;
            }
        }

        /* Animaciones generales */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <a href="index.html" class="home-button" title="Inicio">
        <i class="fas fa-home"></i>
    </a>

    <div class="dashboard-fixed">
        <div class="dashboard-content">
            <div class="dashboard-grid">
                <div class="dashboard-item">
                    <i class="fas fa-user-md"></i>
                    <div>Examen</div>
                    <div id="exam-progress">0%</div>
                </div>
                <div class="dashboard-item">
                    <i class="fas fa-clipboard-list"></i>
                    <div>Secciones</div>
                    <div id="sections-completed">0/9</div>
                </div>
                <div class="dashboard-item dashboard-alert" id="alerts-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Alertas</div>
                    <div id="alert-count">0</div>
                </div>
                <div class="dashboard-item dashboard-warning" id="warnings-item">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>Avisos</div>
                    <div id="warning-count">0</div>
                </div>
                <div class="dashboard-item dashboard-normal" id="findings-item">
                    <i class="fas fa-search"></i>
                    <div>Hallazgos</div>
                    <div id="findings-count">0</div>
                </div>
                <div class="dashboard-item">
                    <i class="fas fa-eye"></i>
                    <div>AV OD</div>
                    <div id="av-od-status">--</div>
                </div>
                 <div class="dashboard-item">
                    <i class="fas fa-eye"></i>
                    <div>AV OI</div>
                    <div id="av-oi-status">--</div>
                </div>
                 <div class="dashboard-item">
                    <i class="fas fa-eye-dropper"></i>
                    <div>PIO OD</div>
                    <div id="pio-od-status">--</div>
                </div>
                 <div class="dashboard-item">
                    <i class="fas fa-eye-dropper"></i>
                    <div>PIO OI</div>
                    <div id="pio-oi-status">--</div>
                </div>
            </div>
            <div class="control-bar">
                <button class="control-btn btn-primary" onclick="toggleNavPanel()">
                    <i class="fas fa-bars"></i> Navegaci√≥n
                </button>
                <button class="control-btn btn-primary" onclick="toggleStickyPanel()" id="sticky-toggle-btn">
                    <i class="fas fa-columns"></i> Vista Dividida
                </button>
                <button class="control-btn btn-success" onclick="generateConclusion()">
                    <i class="fas fa-file-medical"></i> Generar
                </button>
                <button class="control-btn btn-warning" onclick="expandAllSections()">
                    <i class="fas fa-expand-alt"></i> Expandir
                </button>
                <button class="control-btn btn-danger" onclick="clearForm()">
                    <i class="fas fa-trash"></i> Limpiar
                </button>
            </div>
        </div>
    </div>

    <div class="nav-panel" id="nav-panel">
        <h3><i class="fas fa-map"></i> Navegaci√≥n R√°pida</h3>
        <div class="nav-item" onclick="scrollToSection('anamnesis-section')">
            <i class="fas fa-user-edit"></i>
            <span>Anamnesis</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-anamnesis"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('visual-acuity-section')">
            <i class="fas fa-chart-line"></i>
            <span>Agudeza Visual</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-visual-acuity"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('pupil-exam-section')">
            <i class="fas fa-dot-circle"></i>
            <span>Pupilas</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-pupil-exam"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('external-exam-section')">
            <i class="fas fa-eye"></i>
            <span>Examen Externo</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-external-exam"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('motility-exam-section')">
            <i class="fas fa-arrows-alt"></i>
            <span>Motilidad Ocular</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-motility-exam"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('anterior-segment-section')">
            <i class="fas fa-microscope"></i>
            <span>Segmento Anterior</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-anterior-segment"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('pressure-exam-section')">
            <i class="fas fa-hand-holding-medical"></i>
            <span>Presi√≥n Intraocular</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-pressure-exam"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('fundoscopy-section')">
            <i class="fas fa-eye-slash"></i>
            <span>Fundoscop√≠a</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-fundoscopy"></i>
        </div>
        <div class="nav-item" onclick="scrollToSection('scales-section')">
            <i class="fas fa-balance-scale"></i>
            <span>Escalas</span>
            <i class="fas fa-check" style="margin-left: auto; opacity: 0;" id="nav-scales"></i>
        </div>
    </div>

    <div class="sticky-panel" id="stickyConclusion">
        <div class="sticky-header">
            <span><i class="fas fa-file-medical-alt"></i> Informe en Tiempo Real</span>
            <div class="sticky-controls">
                <button class="sticky-btn" onclick="copyStickyToClipboard()" title="Copiar informe">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="sticky-btn" onclick="printStickyConclusion()" title="Imprimir informe">
                    <i class="fas fa-print"></i>
                </button>
                <button class="sticky-btn" onclick="generateStickyConclusion()" title="Actualizar informe">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="sticky-content" id="stickyContent">
            Seleccione los par√°metros del examen para generar el informe en tiempo real...
        </div>
        <div class="update-indicator" id="updateIndicator">
            <div class="spinner"></div>
            <span>Actualizando informe...</span>
        </div>
    </div>

    <div class="copy-notification" id="copyNotification">
        <i class="fas fa-check-circle"></i>
        <span>¬°Informe copiado al portapapeles!</span>
    </div>

    <div class="main-container">
        <h1><i class="fas fa-eye-alt"></i> Examen Oftalmol√≥gico - Algoritmo de Evaluaci√≥n</h1>
        
        <div class="section" id="anamnesis-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-user-edit"></i> Anamnesis y Quejas Principales</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-anamnesis">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="anamnesis">
                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-clipboard-list"></i> Quejas Oftalmol√≥gicas Principales</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item"><input type="checkbox" id="dolor-ocular" onchange="handlePainComplaint(this)"><label for="dolor-ocular">Dolor ocular</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="vision-borrosa" onchange="updateDashboard()"><label for="vision-borrosa">Visi√≥n borrosa</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="perdida-vision" onchange="updateDashboard()"><label for="perdida-vision">P√©rdida de visi√≥n</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="diplopia" onchange="updateDashboard()"><label for="diplopia">Diplop√≠a</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="fotofobia" onchange="updateDashboard()"><label for="fotofobia">Fotofobia</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="lagrimeo" onchange="updateDashboard()"><label for="lagrimeo">Lagrimeo</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="ojo-seco" onchange="updateDashboard()"><label for="ojo-seco">Ojo seco</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="secrecion-ocular" onchange="updateDashboard()"><label for="secrecion-ocular">Secreci√≥n ocular</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="prurito-ocular" onchange="updateDashboard()"><label for="prurito-ocular">Prurito ocular</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="sensacion-cuerpo-extrano" onchange="updateDashboard()"><label for="sensacion-cuerpo-extrano">Sensaci√≥n de cuerpo extra√±o</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="halos-visuales" onchange="updateDashboard()"><label for="halos-visuales">Halos visuales</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="destellos-luz" onchange="updateDashboard()"><label for="destellos-luz">Destellos de luz</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="moscas-volantes" onchange="updateDashboard()"><label for="moscas-volantes">Moscas volantes</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="ceguera-nocturna" onchange="updateDashboard()"><label for="ceguera-nocturna">Ceguera nocturna</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="perdida-campo-visual" onchange="updateDashboard()"><label for="perdida-campo-visual">P√©rdida de campo visual</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="metamorfopsia" onchange="updateDashboard()"><label for="metamorfopsia">Metamorfopsia</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="cefalea" onchange="updateDashboard()"><label for="cefalea">Cefalea</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="ptosis-palpebral" onchange="updateDashboard()"><label for="ptosis-palpebral">Ptosis palpebral</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="ojo-rojo" onchange="updateDashboard()"><label for="ojo-rojo">Ojo rojo</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="sin-quejas-oftalmo" onchange="handleNoComplaints()"><label for="sin-quejas-oftalmo">Sin quejas</label></div>
                    </div>
                </div>

                <div class="exam-container" id="pain-characteristics-section">
                    <div class="exam-header"><i class="fas fa-thermometer-half"></i> Caracter√≠sticas del Dolor Ocular</div>
                    <div class="severity-section">
                        <h4>Intensidad del Dolor (EVA)</h4>
                        <div class="measurement">
                            <label>Dolor ojo derecho:</label>
                            <input type="range" id="dolor-od-intensidad" min="0" max="10" value="0" oninput="updateDolorValue('od', this.value)">
                            <span id="dolor-od-value">0</span><span>/10</span>
                        </div>
                        <div class="measurement">
                            <label>Dolor ojo izquierdo:</label>
                            <input type="range" id="dolor-oi-intensidad" min="0" max="10" value="0" oninput="updateDolorValue('oi', this.value)">
                            <span id="dolor-oi-value">0</span><span>/10</span>
                        </div>
                    </div>
                    <div class="exam-section">
                        <h4>Tipo de Dolor</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="radio" name="tipo-dolor-ocular" id="dolor-punzante" onchange="updateDashboard()"><label for="dolor-punzante">Punzante</label></div>
                            <div class="checkbox-item"><input type="radio" name="tipo-dolor-ocular" id="dolor-urente" onchange="updateDashboard()"><label for="dolor-urente">Urente</label></div>
                            <div class="checkbox-item"><input type="radio" name="tipo-dolor-ocular" id="dolor-presion" onchange="updateDashboard()"><label for="dolor-presion">Sensaci√≥n de presi√≥n</label></div>
                            <div class="checkbox-item"><input type="radio" name="tipo-dolor-ocular" id="dolor-arenoso" onchange="updateDashboard()"><label for="dolor-arenoso">Arenoso</label></div>
                            <div class="checkbox-item"><input type="radio" name="tipo-dolor-ocular" id="dolor-orbital" onchange="updateDashboard()"><label for="dolor-orbital">Dolor orbital profundo</label></div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-history"></i> Historia Ocular y Antecedentes</div>
                    <div class="exam-section">
                        <h4>Antecedentes Oftalmol√≥gicos</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" id="uso-lentes" onchange="updateDashboard()"><label for="uso-lentes">Uso de lentes</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="cirugia-ocular-previa" onchange="updateDashboard()"><label for="cirugia-ocular-previa">Cirug√≠a ocular previa</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trauma-ocular" onchange="updateDashboard()"><label for="trauma-ocular">Trauma ocular</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="glaucoma-familiar" onchange="updateGlaucomaHighlights(this)"><label for="glaucoma-familiar">Antecedente familiar de glaucoma</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="diabetes" onchange="updateDiabetesHighlights(this)"><label for="diabetes">Diabetes mellitus</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="hipertension" onchange="updateHypertensionHighlights(this)"><label for="hipertension">Hipertensi√≥n arterial</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="medicamentos-oftalmicos" onchange="updateDashboard()"><label for="medicamentos-oftalmicos">Uso de medicamentos oft√°lmicos</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="corticoides-topicos" onchange="updateDashboard()"><label for="corticoides-topicos">Uso de corticoides t√≥picos</label></div>
                        </div>
                    </div>
                    <div class="exam-section">
                        <h4>Factores de Riesgo</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" id="exposicion-uv" onchange="updateDashboard()"><label for="exposicion-uv">Exposici√≥n UV excesiva</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trabajo-computadora" onchange="updateDashboard()"><label for="trabajo-computadora">Trabajo prolongado en computadora</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="exposicion-quimicos" onchange="updateDashboard()"><label for="exposicion-quimicos">Exposici√≥n a qu√≠micos</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="soldadura" onchange="updateDashboard()"><label for="soldadura">Soldadura</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="miop√≠a-alta" onchange="updateDashboard()"><label for="miop√≠a-alta">Miop√≠a alta</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="edad-avanzada" onchange="updateDashboard()"><label for="edad-avanzada">Edad avanzada (&gt;60 a√±os)</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section" id="visual-acuity-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-chart-bar"></i> Evaluaci√≥n de la Agudeza Visual</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-visual-acuity">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="visual-acuity">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color vision-color"></div>
                        <span>Evaluaci√≥n Visual</span>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-glasses"></i> Agudeza Visual</div>
                    <div class="visual-acuity">
                        <h4>Agudeza Visual de Lejos (6 metros / 20 pies)</h4>
                        <div class="bilateral-container">
                            <div class="side-container">
                                <div class="side-header">Ojo Derecho (OD)</div>
                                <div class="acuity-grid">
                                    <div class="acuity-item">
                                        <div class="acuity-label">Sin Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-lejos-od-sc" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('od')">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Con Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-lejos-od-cc" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('od')">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Agujero Estenopeico</div>
                                        <input type="text" class="acuity-input" id="av-lejos-od-ph" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('od')">
                                    </div>
                                </div>
                            </div>
                            <div class="side-container">
                                <div class="side-header">Ojo Izquierdo (OI)</div>
                                <div class="acuity-grid">
                                    <div class="acuity-item">
                                        <div class="acuity-label">Sin Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-lejos-oi-sc" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('oi')">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Con Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-lejos-oi-cc" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('oi')">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Agujero Estenopeico</div>
                                        <input type="text" class="acuity-input" id="av-lejos-oi-ph" placeholder="20/20" onchange="updateDashboard(); evaluateAVStatus('oi')">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="visual-acuity">
                        <h4>Agudeza Visual de Cerca (40 cm)</h4>
                        <div class="bilateral-container">
                            <div class="side-container">
                                <div class="side-header">Ojo Derecho (OD)</div>
                                <div class="acuity-grid">
                                    <div class="acuity-item">
                                        <div class="acuity-label">Sin Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-cerca-od-sc" placeholder="J1" onchange="updateDashboard()">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Con Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-cerca-od-cc" placeholder="J1" onchange="updateDashboard()">
                                    </div>
                                </div>
                            </div>
                            <div class="side-container">
                                <div class="side-header">Ojo Izquierdo (OI)</div>
                                <div class="acuity-grid">
                                    <div class="acuity-item">
                                        <div class="acuity-label">Sin Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-cerca-oi-sc" placeholder="J1" onchange="updateDashboard()">
                                    </div>
                                    <div class="acuity-item">
                                        <div class="acuity-label">Con Correcci√≥n</div>
                                        <input type="text" class="acuity-input" id="av-cerca-oi-cc" placeholder="J1" onchange="updateDashboard()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-bullseye"></i> Evaluaci√≥n de Campo Visual</div>
                    <div class="field-defect">
                        <h4>Campo Visual por Confrontaci√≥n</h4>
                        <div class="visual-field-map">
                            <div class="eye-field">
                                <h5>Campo Visual Ojo Derecho</h5>
                                <div class="field-grid">
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="od-sup-temporal">Sup Temporal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="od-sup-nasal">Sup Nasal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="od-inf-temporal">Inf Temporal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="od-inf-nasal">Inf Nasal</div>
                                </div>
                            </div>
                            <div class="eye-field">
                                <h5>Campo Visual Ojo Izquierdo</h5>
                                <div class="field-grid">
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="oi-sup-nasal">Sup Nasal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="oi-sup-temporal">Sup Temporal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="oi-inf-nasal">Inf Nasal</div>
                                    <div class="field-quadrant" onclick="toggleFieldDefect(this)" data-field="oi-inf-temporal">Inf Temporal</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="exam-section">
                        <h4>Tipos de Defectos Campim√©tricos</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" id="campo-normal" onchange="updateDashboard()"><label for="campo-normal">Campo visual normal</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="hemianopsia-hom√≥nima" onchange="updateDashboard()"><label for="hemianopsia-hom√≥nima">Hemianopsia hom√≥nima</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="hemianopsia-heteronima" onchange="updateDashboard()"><label for="hemianopsia-heteronima">Hemianopsia heter√≥nima</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="cuadrantanopsia" onchange="updateDashboard()"><label for="cuadrantanopsia">Cuadrantanopsia</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="escotoma-central" onchange="updateDashboard()"><label for="escotoma-central">Escotoma central</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="escotoma-paracentral" onchange="updateDashboard()"><label for="escotoma-paracentral">Escotoma paracentral</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="defecto-altitudinal" onchange="updateDashboard()"><label for="defecto-altitudinal">Defecto altitudinal</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="constriccion-concentrica" onchange="updateDashboard()"><label for="constriccion-concentrica">Constricci√≥n conc√©ntrica</label></div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-palette"></i> Visi√≥n de Colores</div>
                    <div class="color-vision">
                        <h4>Pruebas de Discromatopsia</h4>
                        <div class="test-results">
                            <div class="test-item">
                                <label>Test de Ishihara (OD)</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="ishihara-od-normal" onchange="handleMutuallyExclusive('ishihara-od-normal', 'ishihara-od-alterado', this)"><span class="negative">Normal</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="ishihara-od-alterado" onchange="handleMutuallyExclusive('ishihara-od-normal', 'ishihara-od-alterado', this)"><span class="positive">Alterado</span></div>
                                    <input type="text" class="input-field" id="ishihara-od-score" placeholder="Puntuaci√≥n" style="width: 80px;" onchange="updateDashboard()">
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Test de Ishihara (OI)</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="ishihara-oi-normal" onchange="handleMutuallyExclusive('ishihara-oi-normal', 'ishihara-oi-alterado', this)"><span class="negative">Normal</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="ishihara-oi-alterado" onchange="handleMutuallyExclusive('ishihara-oi-normal', 'ishihara-oi-alterado', this)"><span class="positive">Alterado</span></div>
                                    <input type="text" class="input-field" id="ishihara-oi-score" placeholder="Puntuaci√≥n" style="width: 80px;" onchange="updateDashboard()">
                                </div>
                            </div>
                        </div>
                        <div class="exam-section">
                            <h4>Tipo de Discromatopsia</h4>
                            <div class="checkbox-grid">
                                <div class="checkbox-item"><input type="radio" name="tipo-discromatopsia" id="protanopia" onchange="updateDashboard()"><label for="protanopia">Protanopia (rojo)</label></div>
                                <div class="checkbox-item"><input type="radio" name="tipo-discromatopsia" id="deuteranopia" onchange="updateDashboard()"><label for="deuteranopia">Deuteranopia (verde)</label></div>
                                <div class="checkbox-item"><input type="radio" name="tipo-discromatopsia" id="tritanopia" onchange="updateDashboard()"><label for="tritanopia">Tritanopia (azul)</label></div>
                                <div class="checkbox-item"><input type="radio" name="tipo-discromatopsia" id="acromatopsia" onchange="updateDashboard()"><label for="acromatopsia">Acromatopsia</label></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="pupil-exam-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-dot-circle"></i> Examen Pupilar</span>
                 <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-pupil-exam">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="pupil-exam">
                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-lightbulb"></i> Evaluaci√≥n Pupilar</div>
                    <div class="pupil-assessment">
                        <h4>Tama√±o y Forma Pupilar</h4>
                        <div class="pupil-grid">
                            <div class="pupil-eye">
                                <h5>Ojo Derecho</h5>
                                <div class="measurement">
                                    <label>Tama√±o (luz):</label>
                                    <input type="number" class="input-field" id="pupila-od-luz" min="1" max="8" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                                <div class="measurement">
                                    <label>Tama√±o (oscuridad):</label>
                                    <input type="number" class="input-field" id="pupila-od-oscuridad" min="1" max="8" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="radio" name="forma-od" id="forma-od-redonda" onchange="updateDashboard()"><label for="forma-od-redonda">Redonda</label></div>
                                    <div class="checkbox-item"><input type="radio" name="forma-od" id="forma-od-irregular" onchange="updateDashboard()"><label for="forma-od-irregular">Irregular</label></div>
                                    <div class="checkbox-item"><input type="radio" name="forma-od" id="forma-od-ovalada" onchange="updateDashboard()"><label for="forma-od-ovalada">Ovalada</label></div>
                                </div>
                            </div>
                            <div class="pupil-eye">
                                <h5>Ojo Izquierdo</h5>
                                <div class="measurement">
                                    <label>Tama√±o (luz):</label>
                                    <input type="number" class="input-field" id="pupila-oi-luz" min="1" max="8" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                                <div class="measurement">
                                    <label>Tama√±o (oscuridad):</label>
                                    <input type="number" class="input-field" id="pupila-oi-oscuridad" min="1" max="8" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="radio" name="forma-oi" id="forma-oi-redonda" onchange="updateDashboard()"><label for="forma-oi-redonda">Redonda</label></div>
                                    <div class="checkbox-item"><input type="radio" name="forma-oi" id="forma-oi-irregular" onchange="updateDashboard()"><label for="forma-oi-irregular">Irregular</label></div>
                                    <div class="checkbox-item"><input type="radio" name="forma-oi" id="forma-oi-ovalada" onchange="updateDashboard()"><label for="forma-oi-ovalada">Ovalada</label></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exam-section">
                        <h4>Reflejos Pupilares</h4>
                        <div class="test-results">
                            <div class="test-item">
                                <label>Reflejo fotomotor directo OD</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="fotomotor-directo-od-pos" onchange="handleMutuallyExclusive('fotomotor-directo-od-pos', 'fotomotor-directo-od-neg', this)"><span class="negative">Presente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="fotomotor-directo-od-neg" onchange="handleMutuallyExclusive('fotomotor-directo-od-pos', 'fotomotor-directo-od-neg', this)"><span class="positive">Ausente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Reflejo fotomotor directo OI</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="fotomotor-directo-oi-pos" onchange="handleMutuallyExclusive('fotomotor-directo-oi-pos', 'fotomotor-directo-oi-neg', this)"><span class="negative">Presente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="fotomotor-directo-oi-neg" onchange="handleMutuallyExclusive('fotomotor-directo-oi-pos', 'fotomotor-directo-oi-neg', this)"><span class="positive">Ausente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Reflejo consensual OD ‚Üí OI</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="consensual-od-oi-pos" onchange="handleMutuallyExclusive('consensual-od-oi-pos', 'consensual-od-oi-neg', this)"><span class="negative">Presente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="consensual-od-oi-neg" onchange="handleMutuallyExclusive('consensual-od-oi-pos', 'consensual-od-oi-neg', this)"><span class="positive">Ausente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Reflejo consensual OI ‚Üí OD</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="consensual-oi-od-pos" onchange="handleMutuallyExclusive('consensual-oi-od-pos', 'consensual-oi-od-neg', this)"><span class="negative">Presente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="consensual-oi-od-neg" onchange="handleMutuallyExclusive('consensual-oi-od-pos', 'consensual-oi-od-neg', this)"><span class="positive">Ausente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Test de Marcus Gunn (DPAR)</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="marcus-gunn-neg" onchange="handleMutuallyExclusive('marcus-gunn-neg', 'marcus-gunn-pos', this)"><span class="negative">Negativo</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="marcus-gunn-pos" onchange="handleMutuallyExclusive('marcus-gunn-neg', 'marcus-gunn-pos', this)"><span class="positive">Positivo</span></div>
                                    <select id="marcus-gunn-ojo" onchange="updateDashboard()">
                                        <option value="">¬øCu√°l ojo?</option>
                                        <option value="OD">OD</option>
                                        <option value="OI">OI</option>
                                    </select>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Reflejo de acomodaci√≥n</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="acomodacion-normal" onchange="handleMutuallyExclusive('acomodacion-normal', 'acomodacion-alterado', this)"><span class="negative">Normal</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="acomodacion-alterado" onchange="handleMutuallyExclusive('acomodacion-normal', 'acomodacion-alterado', this)"><span class="positive">Alterado</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="external-exam-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-eye"></i> Examen Externo del Ojo</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-external-exam">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="external-exam">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color external-color"></div>
                        <span>Examen Externo</span>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-eye"></i> P√°rpados</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">P√°rpados Ojo Derecho</div>
                            <div class="exam-section">
                                <h4>P√°rpado Superior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="parpado-sup-od-normal" onchange="updateDashboard()"><label for="parpado-sup-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ptosis-od" onchange="updateDashboard()"><label for="ptosis-od">Ptosis</label></div>
                                   <div class="checkbox-item"><input type="checkbox" id="retraccion-od" onchange="updateDashboard()"><label for="retraccion-od">Retracci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="edema-od" onchange="updateDashboard()"><label for="edema-od">Edema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="eritema-od" onchange="updateDashboard()"><label for="eritema-od">Eritema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="lesion-od" onchange="updateDashboard()"><label for="lesion-od">Lesi√≥n</label></div>
                                </div>
                                <div class="measurement">
                                    <label>Hendidura palpebral:</label>
                                    <input type="number" class="input-field" id="hendidura-od" min="0" max="15" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>P√°rpado Inferior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="parpado-inf-od-normal" onchange="updateDashboard()"><label for="parpado-inf-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ectropion-od" onchange="updateDashboard()"><label for="ectropion-od">Ectropi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="entropion-od" onchange="updateDashboard()"><label for="entropion-od">Entropi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="bolsas-od" onchange="updateDashboard()"><label for="bolsas-od">Bolsas palpebrales</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Pesta√±as</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="pestanas-od-normales" onchange="updateDashboard()"><label for="pestanas-od-normales">Normales</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="triquiasis-od" onchange="updateDashboard()"><label for="triquiasis-od">Triquiasis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="distiquiasis-od" onchange="updateDashboard()"><label for="distiquiasis-od">Distiquiasis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="madarosis-od" onchange="updateDashboard()"><label for="madarosis-od">Madarosis</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">P√°rpados Ojo Izquierdo</div>
                            <div class="exam-section">
                                <h4>P√°rpado Superior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="parpado-sup-oi-normal" onchange="updateDashboard()"><label for="parpado-sup-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ptosis-oi" onchange="updateDashboard()"><label for="ptosis-oi">Ptosis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="retraccion-oi" onchange="updateDashboard()"><label for="retraccion-oi">Retracci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="edema-oi" onchange="updateDashboard()"><label for="edema-oi">Edema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="eritema-oi" onchange="updateDashboard()"><label for="eritema-oi">Eritema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="lesion-oi" onchange="updateDashboard()"><label for="lesion-oi">Lesi√≥n</label></div>
                                </div>
                                <div class="measurement">
                                    <label>Hendidura palpebral:</label>
                                    <input type="number" class="input-field" id="hendidura-oi" min="0" max="15" step="0.5" onchange="updateDashboard()">
                                    <span>mm</span>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>P√°rpado Inferior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="parpado-inf-oi-normal" onchange="updateDashboard()"><label for="parpado-inf-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ectropion-oi" onchange="updateDashboard()"><label for="ectropion-oi">Ectropi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="entropion-oi" onchange="updateDashboard()"><label for="entropion-oi">Entropi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="bolsas-oi" onchange="updateDashboard()"><label for="bolsas-oi">Bolsas palpebrales</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Pesta√±as</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="pestanas-oi-normales" onchange="updateDashboard()"><label for="pestanas-oi-normales">Normales</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="triquiasis-oi" onchange="updateDashboard()"><label for="triquiasis-oi">Triquiasis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="distiquiasis-oi" onchange="updateDashboard()"><label for="distiquiasis-oi">Distiquiasis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="madarosis-oi" onchange="updateDashboard()"><label for="madarosis-oi">Madarosis</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-tint"></i> Aparato Lagrimal</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Sistema Lagrimal Derecho</div>
                            <div class="exam-section">
                                <h4>Gl√°ndula Lagrimal</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="glandula-lagrimal-od-normal" onchange="updateDashboard()"><label for="glandula-lagrimal-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="dacrioadenitis-od" onchange="updateDashboard()"><label for="dacrioadenitis-od">Dacrioadenitis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="masa-lagrimal-od" onchange="updateDashboard()"><label for="masa-lagrimal-od">Masa palpable</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>V√≠a Lagrimal</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="via-lagrimal-od-normal" onchange="updateDashboard()"><label for="via-lagrimal-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="epifora-od" onchange="updateDashboard()"><label for="epifora-od">Ep√≠fora</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="dacriocistitis-od" onchange="updateDashboard()"><label for="dacriocistitis-od">Dacriocistitis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="mucocele-od" onchange="updateDashboard()"><label for="mucocele-od">Mucocele</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Sistema Lagrimal Izquierdo</div>
                            <div class="exam-section">
                                <h4>Gl√°ndula Lagrimal</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="glandula-lagrimal-oi-normal" onchange="updateDashboard()"><label for="glandula-lagrimal-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="dacrioadenitis-oi" onchange="updateDashboard()"><label for="dacrioadenitis-oi">Dacrioadenitis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="masa-lagrimal-oi" onchange="updateDashboard()"><label for="masa-lagrimal-oi">Masa palpable</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>V√≠a Lagrimal</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="via-lagrimal-oi-normal" onchange="updateDashboard()"><label for="via-lagrimal-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="epifora-oi" onchange="updateDashboard()"><label for="epifora-oi">Ep√≠fora</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="dacriocistitis-oi" onchange="updateDashboard()"><label for="dacriocistitis-oi">Dacriocistitis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="mucocele-oi" onchange="updateDashboard()"><label for="mucocele-oi">Mucocele</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-compress"></i> Conjuntiva y Esclera</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Ojo Derecho</div>
                            <div class="exam-section">
                                <h4>Conjuntiva Bulbar</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="conjuntiva-bulbar-od-normal" onchange="updateDashboard()"><label for="conjuntiva-bulbar-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hiperemia-conjuntival-od" onchange="updateDashboard()"><label for="hiperemia-conjuntival-od">Hiperemia</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="quemosis-od" onchange="updateDashboard()"><label for="quemosis-od">Quemosis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragia-subconjuntival-od" onchange="updateDashboard()"><label for="hemorragia-subconjuntival-od">Hemorragia subconjuntival</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pinguecula-od" onchange="updateDashboard()"><label for="pinguecula-od">Ping√º√©cula</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pterigion-od" onchange="updateDashboard()"><label for="pterigion-od">Pterigi√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Conjuntiva Palpebral</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="conjuntiva-palpebral-od-normal" onchange="updateDashboard()"><label for="conjuntiva-palpebral-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="fol√≠culos-od" onchange="updateDashboard()"><label for="fol√≠culos-od">Fol√≠culos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="papilas-od" onchange="updateDashboard()"><label for="papilas-od">Papilas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cicatrices-od" onchange="updateDashboard()"><label for="cicatrices-od">Cicatrices</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Esclera</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="esclera-od-normal" onchange="updateDashboard()"><label for="esclera-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="escleritis-od" onchange="updateDashboard()"><label for="escleritis-od">Escleritis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="epiescleritis-od" onchange="updateDashboard()"><label for="epiescleritis-od">Epiescleritis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ictericia-escleral-od" onchange="updateDashboard()"><label for="ictericia-escleral-od">Ictericia escleral</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Ojo Izquierdo</div>
                            <div class="exam-section">
                                <h4>Conjuntiva Bulbar</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="conjuntiva-bulbar-oi-normal" onchange="updateDashboard()"><label for="conjuntiva-bulbar-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hiperemia-conjuntival-oi" onchange="updateDashboard()"><label for="hiperemia-conjuntival-oi">Hiperemia</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="quemosis-oi" onchange="updateDashboard()"><label for="quemosis-oi">Quemosis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragia-subconjuntival-oi" onchange="updateDashboard()"><label for="hemorragia-subconjuntival-oi">Hemorragia subconjuntival</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pinguecula-oi" onchange="updateDashboard()"><label for="pinguecula-oi">Ping√º√©cula</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pterigion-oi" onchange="updateDashboard()"><label for="pterigion-oi">Pterigi√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Conjuntiva Palpebral</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="conjuntiva-palpebral-oi-normal" onchange="updateDashboard()"><label for="conjuntiva-palpebral-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="fol√≠culos-oi" onchange="updateDashboard()"><label for="fol√≠culos-oi">Fol√≠culos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="papilas-oi" onchange="updateDashboard()"><label for="papilas-oi">Papilas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cicatrices-oi" onchange="updateDashboard()"><label for="cicatrices-oi">Cicatrices</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Esclera</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="esclera-oi-normal" onchange="updateDashboard()"><label for="esclera-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="escleritis-oi" onchange="updateDashboard()"><label for="escleritis-oi">Escleritis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="epiescleritis-oi" onchange="updateDashboard()"><label for="epiescleritis-oi">Epiescleritis</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="ictericia-escleral-oi" onchange="updateDashboard()"><label for="ictericia-escleral-oi">Ictericia escleral</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="motility-exam-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-arrows-alt"></i> Examen de Motilidad Ocular</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-motility-exam">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="motility-exam">
                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-crosshairs"></i> Movimientos Oculares</div>
                    <div class="exam-section">
                        <h4>Ducciones (Movimientos Monoculares)</h4>
                        <div class="bilateral-container">
                            <div class="side-container">
                                <div class="side-header">Ojo Derecho</div>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="duccion-od-normal" onchange="updateDashboard()"><label for="duccion-od-normal">Ducciones normales</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-aduccion-od" onchange="updateDashboard()"><label for="limitacion-aduccion-od">Limitaci√≥n aducci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-abduccion-od" onchange="updateDashboard()"><label for="limitacion-abduccion-od">Limitaci√≥n abducci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-elevacion-od" onchange="updateDashboard()"><label for="limitacion-elevacion-od">Limitaci√≥n elevaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-depresion-od" onchange="updateDashboard()"><label for="limitacion-depresion-od">Limitaci√≥n depresi√≥n</label></div>
                                </div>
                            </div>
                            <div class="side-container">
                                <div class="side-header">Ojo Izquierdo</div>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="duccion-oi-normal" onchange="updateDashboard()"><label for="duccion-oi-normal">Ducciones normales</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-aduccion-oi" onchange="updateDashboard()"><label for="limitacion-aduccion-oi">Limitaci√≥n aducci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-abduccion-oi" onchange="updateDashboard()"><label for="limitacion-abduccion-oi">Limitaci√≥n abducci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-elevacion-oi" onchange="updateDashboard()"><label for="limitacion-elevacion-oi">Limitaci√≥n elevaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="limitacion-depresion-oi" onchange="updateDashboard()"><label for="limitacion-depresion-oi">Limitaci√≥n depresi√≥n</label></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exam-section">
                        <h4>Versiones (Movimientos Binoculares)</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" id="versiones-normales" onchange="updateDashboard()"><label for="versiones-normales">Versiones normales</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-dextroversion" onchange="updateDashboard()"><label for="limitacion-dextroversion">Limitaci√≥n dextroversi√≥n</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-levoversion" onchange="updateDashboard()"><label for="limitacion-levoversion">Limitaci√≥n levoversi√≥n</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-dextroelevacion" onchange="updateDashboard()"><label for="limitacion-dextroelevacion">Limitaci√≥n dextroelevaci√≥n</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-levoelevacion" onchange="updateDashboard()"><label for="limitacion-levoelevacion">Limitaci√≥n levoelevaci√≥n</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-dextrodepresion" onchange="updateDashboard()"><label for="limitacion-dextrodepresion">Limitaci√≥n dextrodepresi√≥n</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="limitacion-levodepresion" onchange="updateDashboard()"><label for="limitacion-levodepresion">Limitaci√≥n levodepresi√≥n</label></div>
                        </div>
                    </div>

                    <div class="exam-section">
                        <h4>Evaluaci√≥n de Diplop√≠a</h4>
                        <div class="test-results">
                            <div class="test-item">
                                <label>Diplop√≠a</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="diplopia-ausente" onchange="handleMutuallyExclusive('diplopia-ausente', 'diplopia-presente', this)"><span class="negative">Ausente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="diplopia-presente" onchange="handleMutuallyExclusive('diplopia-ausente', 'diplopia-presente', this)"><span class="positive">Presente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Tipo de diplop√≠a</label>
                                <div class="test-controls">
                                    <select id="tipo-diplopia" onchange="updateDashboard()">
                                        <option value="">Seleccionar</option>
                                        <option value="horizontal">Horizontal</option>
                                        <option value="vertical">Vertical</option>
                                        <option value="oblicua">Oblicua</option>
                                    </select>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Cover Test</label>
                                <div class="test-controls">
                                    <select id="cover-test" onchange="updateDashboard()">
                                        <option value="">Seleccionar</option>
                                        <option value="ortoforia">Ortoforia</option>
                                        <option value="esoforia">Esoforia</option>
                                        <option value="exoforia">Exoforia</option>
                                        <option value="hiperforia">Hiperforia</option>
                                        <option value="esotropia">Esotrop√≠a</option>
                                        <option value="exotropia">Exotrop√≠a</option>
                                        <option value="hipertropia">Hipertrop√≠a</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exam-section">
                        <h4>Nistagmo</h4>
                        <div class="test-results">
                            <div class="test-item">
                                <label>Nistagmo espont√°neo</label>
                                <div class="test-controls">
                                    <div class="test-checkbox"><input type="checkbox" id="nistagmo-ausente" onchange="handleMutuallyExclusive('nistagmo-ausente', 'nistagmo-presente', this)"><span class="negative">Ausente</span></div>
                                    <div class="test-checkbox"><input type="checkbox" id="nistagmo-presente" onchange="handleMutuallyExclusive('nistagmo-ausente', 'nistagmo-presente', this)"><span class="positive">Presente</span></div>
                                </div>
                            </div>
                            <div class="test-item">
                                <label>Direcci√≥n del nistagmo</label>
                                <div class="test-controls">
                                    <select id="direccion-nistagmo" onchange="updateDashboard()">
                                        <option value="">Seleccionar</option>
                                        <option value="horizontal">Horizontal</option>
                                        <option value="vertical">Vertical</option>
                                        <option value="rotatorio">Rotatorio</option>
                                        <option value="pendular">Pendular</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="anterior-segment-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-eye-dropper"></i> Examen del Segmento Anterior</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-anterior-segment">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="anterior-segment">
                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-circle-notch"></i> C√≥rnea</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">C√≥rnea Ojo Derecho</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-transparente" onchange="updateDashboard()"><label for="cornea-od-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-edema" onchange="updateDashboard()"><label for="cornea-od-edema">Edema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-leucoma" onchange="updateDashboard()"><label for="cornea-od-leucoma">Leucoma</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-abrasion" onchange="updateDashboard()"><label for="cornea-od-abrasion">Abrasi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-ulcera" onchange="updateDashboard()"><label for="cornea-od-ulcera">√ölcera</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-precipitados" onchange="updateDashboard()"><label for="cornea-od-precipitados">Precipitados quer√°ticos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-neovascularizacion" onchange="updateDashboard()"><label for="cornea-od-neovascularizacion">Neovascularizaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-od-degeneracion" onchange="updateDashboard()"><label for="cornea-od-degeneracion">Degeneraci√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Pruebas Especiales</h4>
                                <div class="test-results">
                                    <div class="test-item">
                                        <label>Fluoresce√≠na</label>
                                        <div class="test-controls">
                                            <div class="test-checkbox"><input type="checkbox" id="fluoresceina-od-neg" onchange="handleMutuallyExclusive('fluoresceina-od-neg', 'fluoresceina-od-pos', this)"><span class="negative">Negativa</span></div>
                                            <div class="test-checkbox"><input type="checkbox" id="fluoresceina-od-pos" onchange="handleMutuallyExclusive('fluoresceina-od-neg', 'fluoresceina-od-pos', this)"><span class="positive">Positiva</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">C√≥rnea Ojo Izquierdo</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-transparente" onchange="updateDashboard()"><label for="cornea-oi-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-edema" onchange="updateDashboard()"><label for="cornea-oi-edema">Edema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-leucoma" onchange="updateDashboard()"><label for="cornea-oi-leucoma">Leucoma</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-abrasion" onchange="updateDashboard()"><label for="cornea-oi-abrasion">Abrasi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-ulcera" onchange="updateDashboard()"><label for="cornea-oi-ulcera">√ölcera</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-precipitados" onchange="updateDashboard()"><label for="cornea-oi-precipitados">Precipitados quer√°ticos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-neovascularizacion" onchange="updateDashboard()"><label for="cornea-oi-neovascularizacion">Neovascularizaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cornea-oi-degeneracion" onchange="updateDashboard()"><label for="cornea-oi-degeneracion">Degeneraci√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Pruebas Especiales</h4>
                                <div class="test-results">
                                    <div class="test-item">
                                        <label>Fluoresce√≠na</label>
                                        <div class="test-controls">
                                            <div class="test-checkbox"><input type="checkbox" id="fluoresceina-oi-neg" onchange="handleMutuallyExclusive('fluoresceina-oi-neg', 'fluoresceina-oi-pos', this)"><span class="negative">Negativa</span></div>
                                            <div class="test-checkbox"><input type="checkbox" id="fluoresceina-oi-pos" onchange="handleMutuallyExclusive('fluoresceina-oi-neg', 'fluoresceina-oi-pos', this)"><span class="positive">Positiva</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-layer-group"></i> C√°mara Anterior e Iris</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Ojo Derecho</div>
                            <div class="exam-section">
                                <h4>C√°mara Anterior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-od-normal" onchange="updateDashboard()"><label for="camara-anterior-od-normal">Profundidad normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-od-estrecha" onchange="updateDashboard()"><label for="camara-anterior-od-estrecha">Estrecha</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-od-profunda" onchange="updateDashboard()"><label for="camara-anterior-od-profunda">Profunda</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hipopion-od" onchange="updateDashboard()"><label for="hipopion-od">Hipopi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hifema-od" onchange="updateDashboard()"><label for="hifema-od">Hifema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="celulas-od" onchange="updateDashboard()"><label for="celulas-od">C√©lulas inflamatorias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="flare-od" onchange="updateDashboard()"><label for="flare-od">Flare</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Iris</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="iris-od-normal" onchange="updateDashboard()"><label for="iris-od-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="sinequias-anteriores-od" onchange="updateDashboard()"><label for="sinequias-anteriores-od">Sinequias anteriores</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="sinequias-posteriores-od" onchange="updateDashboard()"><label for="sinequias-posteriores-od">Sinequias posteriores</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="atrofia-iris-od" onchange="updateDashboard()"><label for="atrofia-iris-od">Atrofia iris</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="nodulos-iris-od" onchange="updateDashboard()"><label for="nodulos-iris-od">N√≥dulos iris</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-iris-od" onchange="updateDashboard()"><label for="neovascularizacion-iris-od">Neovascularizaci√≥n</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Ojo Izquierdo</div>
                            <div class="exam-section">
                                <h4>C√°mara Anterior</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-oi-normal" onchange="updateDashboard()"><label for="camara-anterior-oi-normal">Profundidad normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-oi-estrecha" onchange="updateDashboard()"><label for="camara-anterior-oi-estrecha">Estrecha</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="camara-anterior-oi-profunda" onchange="updateDashboard()"><label for="camara-anterior-oi-profunda">Profunda</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hipopion-oi" onchange="updateDashboard()"><label for="hipopion-oi">Hipopi√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hifema-oi" onchange="updateDashboard()"><label for="hifema-oi">Hifema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="celulas-oi" onchange="updateDashboard()"><label for="celulas-oi">C√©lulas inflamatorias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="flare-oi" onchange="updateDashboard()"><label for="flare-oi">Flare</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Iris</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="iris-oi-normal" onchange="updateDashboard()"><label for="iris-oi-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="sinequias-anteriores-oi" onchange="updateDashboard()"><label for="sinequias-anteriores-oi">Sinequias anteriores</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="sinequias-posteriores-oi" onchange="updateDashboard()"><label for="sinequias-posteriores-oi">Sinequias posteriores</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="atrofia-iris-oi" onchange="updateDashboard()"><label for="atrofia-iris-oi">Atrofia iris</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="nodulos-iris-oi" onchange="updateDashboard()"><label for="nodulos-iris-oi">N√≥dulos iris</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-iris-oi" onchange="updateDashboard()"><label for="neovascularizacion-iris-oi">Neovascularizaci√≥n</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-gem"></i> Cristalino</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Cristalino Ojo Derecho</div>
                            <div class="exam-section">
                                <h4>Transparencia</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="cristalino-od-transparente" onchange="updateDashboard()"><label for="cristalino-od-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-nuclear-od" onchange="updateDashboard()"><label for="catarata-nuclear-od">Catarata nuclear</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-cortical-od" onchange="updateDashboard()"><label for="catarata-cortical-od">Catarata cortical</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-subcapsular-od" onchange="updateDashboard()"><label for="catarata-subcapsular-od">Catarata subcapsular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-madura-od" onchange="updateDashboard()"><label for="catarata-madura-od">Catarata madura</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pseudofaco-od" onchange="updateDashboard()"><label for="pseudofaco-od">Pseudofaco (LIO)</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="afaco-od" onchange="updateDashboard()"><label for="afaco-od">Afaco</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Grado de Catarata (LOCS III)</h4>
                                <div class="measurement">
                                    <label>Nuclear:</label>
                                    <select id="catarata-nuclear-grado-od" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                    </select>
                                </div>
                                <div class="measurement">
                                    <label>Cortical:</label>
                                    <select id="catarata-cortical-grado-od" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="measurement">
                                    <label>Subcapsular:</label>
                                    <select id="catarata-subcapsular-grado-od" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Cristalino Ojo Izquierdo</div>
                            <div class="exam-section">
                                <h4>Transparencia</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="cristalino-oi-transparente" onchange="updateDashboard()"><label for="cristalino-oi-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-nuclear-oi" onchange="updateDashboard()"><label for="catarata-nuclear-oi">Catarata nuclear</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-cortical-oi" onchange="updateDashboard()"><label for="catarata-cortical-oi">Catarata cortical</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-subcapsular-oi" onchange="updateDashboard()"><label for="catarata-subcapsular-oi">Catarata subcapsular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="catarata-madura-oi" onchange="updateDashboard()"><label for="catarata-madura-oi">Catarata madura</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="pseudofaco-oi" onchange="updateDashboard()"><label for="pseudofaco-oi">Pseudofaco (LIO)</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="afaco-oi" onchange="updateDashboard()"><label for="afaco-oi">Afaco</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Grado de Catarata (LOCS III)</h4>
                                <div class="measurement">
                                    <label>Nuclear:</label>
                                    <select id="catarata-nuclear-grado-oi" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                    </select>
                                </div>
                                <div class="measurement">
                                    <label>Cortical:</label>
                                    <select id="catarata-cortical-grado-oi" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="measurement">
                                    <label>Subcapsular:</label>
                                    <select id="catarata-subcapsular-grado-oi" onchange="updateDashboard()">
                                        <option value="">Grado</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="pressure-exam-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-hand-holding-medical"></i> Presi√≥n Intraocular y Glaucoma</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-pressure-exam">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="pressure-exam">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color pressure-color"></div>
                        <span>Evaluaci√≥n de Presi√≥n</span>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-tachometer-alt"></i> Medici√≥n de Presi√≥n Intraocular</div>
                    <div class="pressure-section">
                        <h4>Tonometr√≠a</h4>
                        <div class="bilateral-container">
                            <div class="side-container">
                                <div class="side-header">Ojo Derecho</div>
                                <div class="measurement">
                                    <label>PIO (tonometr√≠a):</label>
                                    <input type="number" class="input-field" id="pio-od" min="5" max="50" step="1" onchange="evaluatePIO()"><label for="pio-od"></label>
                                    <span>mmHg</span>
                                </div>
                                <div class="measurement">
                                    <label>Hora de medici√≥n:</label>
                                    <input type="time" class="input-field" id="hora-pio-od" style="width: 120px;" onchange="updateDashboard()">
                                </div>
                                <div class="exam-section">
                                    <h4>M√©todo de Medici√≥n</h4>
                                    <div class="checkbox-grid">
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-od" id="goldmann-od" onchange="updateDashboard()"><label for="goldmann-od">Goldmann</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-od" id="neumotonometria-od" onchange="updateDashboard()"><label for="neumotonometria-od">Neumotonometr√≠a</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-od" id="schiotz-od" onchange="updateDashboard()"><label for="schiotz-od">Schiotz</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-od" id="palpacion-od" onchange="updateDashboard()"><label for="palpacion-od">Palpaci√≥n</label></div>
                                    </div>
                                </div>
                            </div>
                            <div class="side-container">
                                <div class="side-header">Ojo Izquierdo</div>
                                <div class="measurement">
                                    <label>PIO (tonometr√≠a):</label>
                                    <input type="number" class="input-field" id="pio-oi" min="5" max="50" step="1" onchange="evaluatePIO()"><label for="pio-oi"></label>
                                    <span>mmHg</span>
                                </div>
                                <div class="measurement">
                                    <label>Hora de medici√≥n:</label>
                                    <input type="time" class="input-field" id="hora-pio-oi" style="width: 120px;" onchange="updateDashboard()">
                                </div>
                                <div class="exam-section">
                                    <h4>M√©todo de Medici√≥n</h4>
                                    <div class="checkbox-grid">
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-oi" id="goldmann-oi" onchange="updateDashboard()"><label for="goldmann-oi">Goldmann</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-oi" id="neumotonometria-oi" onchange="updateDashboard()"><label for="neumotonometria-oi">Neumotonometr√≠a</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-oi" id="schiotz-oi" onchange="updateDashboard()"><label for="schiotz-oi">Schiotz</label></div>
                                        <div class="checkbox-item"><input type="radio" name="metodo-pio-oi" id="palpacion-oi" onchange="updateDashboard()"><label for="palpacion-oi">Palpaci√≥n</label></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="score-calculation">
                            <div class="score-item">
                                <span>Interpretaci√≥n PIO OD:</span>
                                <span class="score-value" id="interpretacion-pio-od">--</span>
                            </div>
                            <div class="score-item">
                                <span>Interpretaci√≥n PIO OI:</span>
                                <span class="score-value" id="interpretacion-pio-oi">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="exam-section">
                        <h4>Factores de Riesgo para Glaucoma</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" id="antecedente-familiar-glaucoma" onchange="updateDashboard()"><label for="antecedente-familiar-glaucoma">Antecedente familiar</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="edad-mayor-40" onchange="updateDashboard()"><label for="edad-mayor-40">Edad &gt; 40 a√±os</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="raza-afroamericana" onchange="updateDashboard()"><label for="raza-afroamericana">Raza afroamericana</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="miopia-alta-glaucoma" onchange="updateDashboard()"><label for="miopia-alta-glaucoma">Miop√≠a alta</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="diabetes-glaucoma" onchange="updateDashboard()"><label for="diabetes-glaucoma">Diabetes</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="uso-corticoides" onchange="updateDashboard()"><label for="uso-corticoides">Uso de corticoides</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="trauma-ocular-previo" onchange="updateDashboard()"><label for="trauma-ocular-previo">Trauma ocular previo</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="fundoscopy-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-eye-slash"></i> Fundoscop√≠a y Segmento Posterior</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-fundoscopy">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="fundoscopy">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color fundus-color"></div>
                        <span>Examen del Fondo</span>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-circle-notch"></i> Disco √ìptico</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Disco √ìptico Derecho</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="disco-od-normal" onchange="updateDashboard()"><label for="disco-od-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="papiledema-od" onchange="updateDashboard()"><label for="papiledema-od">Papiledema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="atrofia-optica-od" onchange="updateDashboard()"><label for="atrofia-optica-od">Atrofia √≥ptica</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="excavacion-aumentada-od" onchange="updateDashboard()"><label for="excavacion-aumentada-od">Excavaci√≥n aumentada</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-disco-od" onchange="updateDashboard()"><label for="hemorragias-disco-od">Hemorragias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="drusas-disco-od" onchange="updateDashboard()"><label for="drusas-disco-od">Drusas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-disco-od" onchange="updateDashboard()"><label for="neovascularizacion-disco-od">Neovascularizaci√≥n</label></div>
                                </div>
                                <div class="measurement">
                                    <label>Relaci√≥n copa/disco:</label>
                                    <input type="number" class="input-field" id="cup-disc-od" min="0" max="1" step="0.1" onchange="evaluateCupDisc('od')"><label for="cup-disc-od"></label>
                                </div>
                                <div class="score-item">
                                    <span>Interpretaci√≥n C/D OD:</span>
                                    <span class="score-value" id="interpretacion-cd-od">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Disco √ìptico Izquierdo</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="disco-oi-normal" onchange="updateDashboard()"><label for="disco-oi-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="papiledema-oi" onchange="updateDashboard()"><label for="papiledema-oi">Papiledema</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="atrofia-optica-oi" onchange="updateDashboard()"><label for="atrofia-optica-oi">Atrofia √≥ptica</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="excavacion-aumentada-oi" onchange="updateDashboard()"><label for="excavacion-aumentada-oi">Excavaci√≥n aumentada</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-disco-oi" onchange="updateDashboard()"><label for="hemorragias-disco-oi">Hemorragias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="drusas-disco-oi" onchange="updateDashboard()"><label for="drusas-disco-oi">Drusas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-disco-oi" onchange="updateDashboard()"><label for="neovascularizacion-disco-oi">Neovascularizaci√≥n</label></div>
                                </div>
                                <div class="measurement">
                                    <label>Relaci√≥n copa/disco:</label>
                                    <input type="number" class="input-field" id="cup-disc-oi" min="0" max="1" step="0.1" onchange="evaluateCupDisc('oi')"><label for="cup-disc-oi"></label>
                                </div>
                                <div class="score-item">
                                    <span>Interpretaci√≥n C/D OI:</span>
                                    <span class="score-value" id="interpretacion-cd-oi">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-bullseye"></i> M√°cula</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">M√°cula Derecha</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="macula-od-normal" onchange="updateDashboard()"><label for="macula-od-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="drusas-od" onchange="updateDashboard()"><label for="drusas-od">Drusas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="degeneracion-macular-od" onchange="updateDashboard()"><label for="degeneracion-macular-od">Degeneraci√≥n macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="edema-macular-od" onchange="updateDashboard()"><label for="edema-macular-od">Edema macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-maculares-od" onchange="updateDashboard()"><label for="hemorragias-maculares-od">Hemorragias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="exudados-duros-od" onchange="updateDashboard()"><label for="exudados-duros-od">Exudados duros</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="exudados-blandos-od" onchange="updateDashboard()"><label for="exudados-blandos-od">Exudados blandos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-macular-od" onchange="updateDashboard()"><label for="neovascularizacion-macular-od">Neovascularizaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="agujero-macular-od" onchange="updateDashboard()"><label for="agujero-macular-od">Agujero macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="membrana-epirretiniana-od" onchange="updateDashboard()"><label for="membrana-epirretiniana-od">Membrana epirretiniana</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">M√°cula Izquierda</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="macula-oi-normal" onchange="updateDashboard()"><label for="macula-oi-normal">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="drusas-oi" onchange="updateDashboard()"><label for="drusas-oi">Drusas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="degeneracion-macular-oi" onchange="updateDashboard()"><label for="degeneracion-macular-oi">Degeneraci√≥n macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="edema-macular-oi" onchange="updateDashboard()"><label for="edema-macular-oi">Edema macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-maculares-oi" onchange="updateDashboard()"><label for="hemorragias-maculares-oi">Hemorragias</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="exudados-duros-oi" onchange="updateDashboard()"><label for="exudados-duros-oi">Exudados duros</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="exudados-blandos-oi" onchange="updateDashboard()"><label for="exudados-blandos-oi">Exudados blandos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-macular-oi" onchange="updateDashboard()"><label for="neovascularizacion-macular-oi">Neovascularizaci√≥n</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="agujero-macular-oi" onchange="updateDashboard()"><label for="agujero-macular-oi">Agujero macular</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="membrana-epirretiniana-oi" onchange="updateDashboard()"><label for="membrana-epirretiniana-oi">Membrana epirretiniana</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-network-wired"></i> Retina Perif√©rica y Vasos</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">Retina Derecha</div>
                            <div class="exam-section">
                                <h4>Vasos Retinianos</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="vasos-od-normales" onchange="updateDashboard()"><label for="vasos-od-normales">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="estrechamiento-arteriolar-od" onchange="updateDashboard()"><label for="estrechamiento-arteriolar-od">Estrechamiento arteriolar</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cruces-av-patologicos-od" onchange="updateDashboard()"><label for="cruces-av-patologicos-od">Cruces A-V patol√≥gicos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-retinianas-od" onchange="updateDashboard()"><label for="hemorragias-retinianas-od">Hemorragias retinianas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="microaneurismas-od" onchange="updateDashboard()"><label for="microaneurismas-od">Microaneurismas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="manchas-algodonosas-od" onchange="updateDashboard()"><label for="manchas-algodonosas-od">Manchas algodonosas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-retiniana-od" onchange="updateDashboard()"><label for="neovascularizacion-retiniana-od">Neovascularizaci√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Retina Perif√©rica</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="retina-periferica-od-normal" onchange="updateDashboard()"><label for="retina-periferica-od-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desgarros-retinianos-od" onchange="updateDashboard()"><label for="desgarros-retinianos-od">Desgarros</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desprendimiento-retina-od" onchange="updateDashboard()"><label for="desprendimiento-retina-od">Desprendimiento</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="degeneracion-lattice-od" onchange="updateDashboard()"><label for="degeneracion-lattice-od">Degeneraci√≥n lattice</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cicatrices-laser-od" onchange="updateDashboard()"><label for="cicatrices-laser-od">Cicatrices l√°ser</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">Retina Izquierda</div>
                            <div class="exam-section">
                                <h4>Vasos Retinianos</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="vasos-oi-normales" onchange="updateDashboard()"><label for="vasos-oi-normales">Aspecto normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="estrechamiento-arteriolar-oi" onchange="updateDashboard()"><label for="estrechamiento-arteriolar-oi">Estrechamiento arteriolar</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cruces-av-patologicos-oi" onchange="updateDashboard()"><label for="cruces-av-patologicos-oi">Cruces A-V patol√≥gicos</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragias-retinianas-oi" onchange="updateDashboard()"><label for="hemorragias-retinianas-oi">Hemorragias retinianas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="microaneurismas-oi" onchange="updateDashboard()"><label for="microaneurismas-oi">Microaneurismas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="manchas-algodonosas-oi" onchange="updateDashboard()"><label for="manchas-algodonosas-oi">Manchas algodonosas</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="neovascularizacion-retiniana-oi" onchange="updateDashboard()"><label for="neovascularizacion-retiniana-oi">Neovascularizaci√≥n</label></div>
                                </div>
                            </div>
                            <div class="exam-section">
                                <h4>Retina Perif√©rica</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="retina-periferica-oi-normal" onchange="updateDashboard()"><label for="retina-periferica-oi-normal">Normal</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desgarros-retinianos-oi" onchange="updateDashboard()"><label for="desgarros-retinianos-oi">Desgarros</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desprendimiento-retina-oi" onchange="updateDashboard()"><label for="desprendimiento-retina-oi">Desprendimiento</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="degeneracion-lattice-oi" onchange="updateDashboard()"><label for="degeneracion-lattice-oi">Degeneraci√≥n lattice</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="cicatrices-laser-oi" onchange="updateDashboard()"><label for="cicatrices-laser-oi">Cicatrices l√°ser</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-glass-whiskey"></i> V√≠treo</div>
                    <div class="bilateral-container">
                        <div class="side-container">
                            <div class="side-header">V√≠treo Derecho</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="vitreo-od-transparente" onchange="updateDashboard()"><label for="vitreo-od-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragia-vitrea-od" onchange="updateDashboard()"><label for="hemorragia-vitrea-od">Hemorragia v√≠trea</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="opacidades-vitreas-od" onchange="updateDashboard()"><label for="opacidades-vitreas-od">Opacidades</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desprendimiento-vitreo-od" onchange="updateDashboard()"><label for="desprendimiento-vitreo-od">Desprendimiento v√≠treo posterior</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="proliferacion-vitreorretiniana-od" onchange="updateDashboard()"><label for="proliferacion-vitreorretiniana-od">Proliferaci√≥n vitreorretiniana</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="celulas-vitreas-od" onchange="updateDashboard()"><label for="celulas-vitreas-od">C√©lulas inflamatorias</label></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="side-container">
                            <div class="side-header">V√≠treo Izquierdo</div>
                            <div class="exam-section">
                                <h4>Caracter√≠sticas</h4>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" id="vitreo-oi-transparente" onchange="updateDashboard()"><label for="vitreo-oi-transparente">Transparente</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="hemorragia-vitrea-oi" onchange="updateDashboard()"><label for="hemorragia-vitrea-oi">Hemorragia v√≠trea</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="opacidades-vitreas-oi" onchange="updateDashboard()"><label for="opacidades-vitreas-oi">Opacidades</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="desprendimiento-vitreo-oi" onchange="updateDashboard()"><label for="desprendimiento-vitreo-oi">Desprendimiento v√≠treo posterior</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="proliferacion-vitreorretiniana-oi" onchange="updateDashboard()"><label for="proliferacion-vitreorretiniana-oi">Proliferaci√≥n vitreorretiniana</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="celulas-vitreas-oi" onchange="updateDashboard()"><label for="celulas-vitreas-oi">C√©lulas inflamatorias</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="scales-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span><i class="fas fa-balance-scale"></i> Escalas de Evaluaci√≥n y Severidad</span>
                <div style="display: flex; align-items: center;">
                    <div class="completion-badge" id="badge-scales">
                        <i class="fas fa-circle"></i>
                    </div>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="section-content" id="scales">
                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-calculator"></i> Escalas Espec√≠ficas Oftalmol√≥gicas</div>
                    <div class="score-calculation">
                        <div class="exam-section">
                            <h4>Clasificaci√≥n de Retinopat√≠a Diab√©tica (ETDRS)</h4>
                            <div class="severity-grid">
                                <div class="severity-item"><input type="radio" name="retinopatia-diabetica" id="rd-sin" onchange="updateDashboard()"><label for="rd-sin">Sin retinopat√≠a diab√©tica</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-diabetica" id="rd-leve" onchange="updateDashboard()"><label for="rd-leve">RD no proliferativa leve</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-diabetica" id="rd-moderada" onchange="updateDashboard()"><label for="rd-moderada">RD no proliferativa moderada</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-diabetica" id="rd-severa" onchange="updateDashboard()"><label for="rd-severa">RD no proliferativa severa</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-diabetica" id="rd-proliferativa" onchange="updateDashboard()"><label for="rd-proliferativa">RD proliferativa</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="score-calculation">
                        <div class="exam-section">
                            <h4>Clasificaci√≥n de Retinopat√≠a Hipertensiva (Keith-Wagener-Barker)</h4>
                            <div class="severity-grid">
                                <div class="severity-item"><input type="radio" name="retinopatia-hipertensiva" id="rh-grado0" onchange="updateDashboard()"><label for="rh-grado0">Grado 0: Normal</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-hipertensiva" id="rh-grado1" onchange="updateDashboard()"><label for="rh-grado1">Grado I: Estrechamiento arteriolar</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-hipertensiva" id="rh-grado2" onchange="updateDashboard()"><label for="rh-grado2">Grado II: Cruces arteriovenosos</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-hipertensiva" id="rh-grado3" onchange="updateDashboard()"><label for="rh-grado3">Grado III: Exudados y hemorragias</label></div>
                                <div class="severity-item"><input type="radio" name="retinopatia-hipertensiva" id="rh-grado4" onchange="updateDashboard()"><label for="rh-grado4">Grado IV: Papiledema</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="score-calculation">
                        <div class="exam-section">
                            <h4>Clasificaci√≥n de Degeneraci√≥n Macular Relacionada con la Edad (AREDS)</h4>
                            <div class="severity-grid">
                                <div class="severity-item"><input type="radio" name="dmre-areds" id="dmre-categoria1" onchange="updateDashboard()"><label for="dmre-categoria1">Categor√≠a 1: Sin DMRE</label></div>
                                <div class="severity-item"><input type="radio" name="dmre-areds" id="dmre-categoria2" onchange="updateDashboard()"><label for="dmre-categoria2">Categor√≠a 2: DMRE temprana</label></div>
                                <div class="severity-item"><input type="radio" name="dmre-areds" id="dmre-categoria3" onchange="updateDashboard()"><label for="dmre-categoria3">Categor√≠a 3: DMRE intermedia</label></div>
                                <div class="severity-item"><input type="radio" name="dmre-areds" id="dmre-categoria4" onchange="updateDashboard()"><label for="dmre-categoria4">Categor√≠a 4: DMRE avanzada</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="score-calculation">
                        <div class="exam-section">
                            <h4>Evaluaci√≥n de Discapacidad Visual (OMS)</h4>
                            <div class="score-item">
                                <span>Mejor ojo - Agudeza Visual:</span>
                                <input type="text" class="input-field" id="mejor-ojo-av" placeholder="20/20" style="width: 80px;" onchange="calculateVisualDisability()"><label for="mejor-ojo-av"></label>
                            </div>
                            <div class="score-item">
                                <span>Clasificaci√≥n OMS:</span>
                                <span class="score-value" id="clasificacion-oms">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exam-container">
                    <div class="exam-header"><i class="fas fa-life-ring"></i> Cuestionarios de Calidad de Vida</div>
                    <div class="score-calculation">
                        <div class="exam-section">
                            <h4>Cuestionario VFQ-25 (Funci√≥n Visual) - Seleccione las m√°s relevantes</h4>
                            <div class="checkbox-grid">
                                <div class="checkbox-item"><input type="checkbox" id="vfq-vision-general" onchange="calculateVFQ()"><label for="vfq-vision-general">Problemas con visi√≥n general</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-actividades-cerca" onchange="calculateVFQ()"><label for="vfq-actividades-cerca">Dificultad actividades de cerca</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-actividades-lejos" onchange="calculateVFQ()"><label for="vfq-actividades-lejos">Dificultad actividades de lejos</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-vision-social" onchange="calculateVFQ()"><label for="vfq-vision-social">Limitaci√≥n en funcionamiento social</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-salud-mental" onchange="calculateVFQ()"><label for="vfq-salud-mental">Problemas de salud mental relacionados</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-dependencia" onchange="calculateVFQ()"><label for="vfq-dependencia">Dependencia de otros</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-conducir" onchange="calculateVFQ()"><label for="vfq-conducir">Problemas para conducir</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-color" onchange="calculateVFQ()"><label for="vfq-color">Problemas visi√≥n de colores</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="vfq-vision-periferica" onchange="calculateVFQ()"><label for="vfq-vision-periferica">Problemas visi√≥n perif√©rica</label></div>
                            </div>
                            <div class="score-item">
                                <span>Impacto estimado VFQ-25:</span>
                                <span class="score-value" id="vfq-score">0</span>
                                <span>/9 √°reas afectadas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="conclusion">
            <h3><i class="fas fa-file-medical-alt"></i> Conclusi√≥n del Examen Oftalmol√≥gico</h3>
            <div class="conclusion-text" id="conclusion-text">Seleccione los par√°metros del examen para generar la conclusi√≥n oftalmol√≥gica...</div>
        </div>
        
        <div class="control-buttons">
            <button class="btn btn-primary" onclick="generateConclusion()">
                <i class="fas fa-file-medical"></i> Generar Conclusi√≥n
            </button>
            <button class="btn btn-primary" onclick="printConclusion()">
                <i class="fas fa-print"></i> Imprimir Conclusi√≥n
            </button>
            <button class="btn btn-secondary" onclick="clearForm()">
                <i class="fas fa-trash"></i> Limpiar Formulario
            </button>
            <button class="btn btn-secondary" onclick="expandAllSections()">
                <i class="fas fa-expand-alt"></i> Expandir Todo
            </button>
            <button class="btn btn-secondary" onclick="collapseAllSections()">
                <i class="fas fa-compress-alt"></i> Contraer Todo
            </button>
        </div>
    </div>

    <script>
        // üé® Variables globales para el dashboard
        let examProgress = 0;
        let sectionsCompleted = 0;
        let alertCount = 0;
        let warningCount = 0;
        let findingsCount = 0;
        let avODStatus = '--';
        let avOIStatus = '--';
        let pioODStatus = '--';
        let pioOIStatus = '--';

        // üåô Toggle de tema
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        // üéØ Toggle panel de navegaci√≥n
        function toggleNavPanel() {
            const navPanel = document.getElementById('nav-panel');
            const body = document.body;
            
            navPanel.classList.toggle('open');
            body.classList.toggle('split-view-nav-active');
        }

        // üìä FUNCIONES DEL PANEL STICKY
        // Toggle panel lateral sticky
        function toggleStickyPanel() {
            const stickyPanel = document.getElementById('stickyConclusion');
            const body = document.body;
            const btn = document.getElementById('sticky-toggle-btn');
            
            stickyPanel.classList.toggle('active');
            body.classList.toggle('split-view-sticky-active');
            
            if (stickyPanel.classList.contains('active')) {
                btn.innerHTML = '<i class="fas fa-window-restore"></i> Vista Normal';
                btn.classList.add('btn-warning');
                btn.classList.remove('btn-primary');
                generateStickyConclusion();
            } else {
                btn.innerHTML = '<i class="fas fa-columns"></i> Vista Dividida';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-warning');
            }
        }

        // Generar conclusi√≥n para panel sticky
        function generateStickyConclusion() {
            const stickyContent = document.getElementById('stickyContent');
            const updateIndicator = document.getElementById('updateIndicator');
            
            updateIndicator.classList.add('active');
            
            setTimeout(() => {
                const originalConclusionEl = document.getElementById('conclusion-text');
                const originalContent = originalConclusionEl.textContent;
                
                stickyContent.textContent = originalContent;
                
                updateIndicator.classList.remove('active');
            }, 300);
        }

        // Copiar contenido del panel sticky
        function copyStickyToClipboard() {
            const stickyContent = document.getElementById('stickyContent').textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(stickyContent).then(() => {
                    showCopyNotification();
                }).catch(err => {
                    console.error('Error al copiar con la API del portapapeles: ', err);
                    fallbackCopyToClipboard(stickyContent);
                });
            } else {
                fallbackCopyToClipboard(stickyContent);
            }
        }

        // Fallback para copiar
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showCopyNotification();
            } catch (err) {
                console.error('Error al usar el m√©todo de respaldo para copiar: ', err);
                alert('No se pudo copiar el texto. Por favor, c√≥pielo manualmente.');
            }

            document.body.removeChild(textArea);
        }

        // Mostrar notificaci√≥n de copia
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2500);
        }

        // Imprimir desde panel sticky
        function printStickyConclusion() {
            const conclusion = document.getElementById('stickyContent').textContent;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Informe Oftalmol√≥gico</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            line-height: 1.6;
                        }
                        pre { 
                            white-space: pre-wrap; 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid var(--primary-color);
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        .footer {
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                            margin-top: 20px;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Informe Oftalmol√≥gico</h1>
                        <p>Fecha: ${new Date().toLocaleDateString()}</p>
                        <p>Hora: ${new Date().toLocaleTimeString()}</p>
                    </div>
                    <pre>${conclusion}</pre>
                    <div class="footer">
                        <p>Generado por Sistema de Evaluaci√≥n Oftalmol√≥gica Premium</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // üß≠ Navegaci√≥n a secciones
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                const header = section.querySelector('.section-header');
                if (!header.classList.contains('expanded')) {
                    toggleSection(header);
                }
            }
        }

        // ‚úÖ Actualizar altura de secci√≥n
        function updateSectionHeight(contentElement) {
            if (contentElement && contentElement.classList.contains('expanded')) {
                setTimeout(() => {
                    contentElement.style.maxHeight = contentElement.scrollHeight + 'px';
                }, 50);
            }
        }

        // üìÇ Toggle de secciones mejorado
        function toggleSection(headerElement) {
            const content = headerElement.nextElementSibling;
            const section = headerElement.parentElement;
            
            headerElement.classList.toggle('expanded');
            section.classList.toggle('active');
            
            if (content.classList.toggle('expanded')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.classList.add('slide-in');
            } else {
                content.style.maxHeight = '0';
                content.classList.remove('slide-in');
            }
        }

        // üîÑ Expandir/contraer todas las secciones
        function expandAllSections() {
            document.querySelectorAll('.section-header:not(.expanded)').forEach(header => {
                toggleSection(header);
            });
        }

        function collapseAllSections() {
            document.querySelectorAll('.section-header.expanded').forEach(header => {
                toggleSection(header);
            });
        }

        // üó∫Ô∏è Toggle de cuadrantes de campo visual
        function toggleFieldDefect(element) {
            element.classList.toggle('defect');
            updateDashboard();
            generateConclusion();
        }
        
        // üö´ Manejo de "Sin quejas"
        function handleNoComplaints() {
            const noComplaintsCheckbox = document.getElementById('sin-quejas-oftalmo');
            const otherCheckboxes = document.querySelectorAll('#anamnesis input[type="checkbox"]:not(#sin-quejas-oftalmo)');
            
            otherCheckboxes.forEach(checkbox => {
                checkbox.disabled = noComplaintsCheckbox.checked;
                if (noComplaintsCheckbox.checked) checkbox.checked = false;
            });
            
            // Ocultar secci√≥n de dolor si "sin quejas" est√° marcado
            const painSection = document.getElementById('pain-characteristics-section');
            if (noComplaintsCheckbox.checked) {
                painSection.classList.add('hidden');
            } else {
                // Si desmarcas "sin quejas", la secci√≥n de dolor se mantiene oculta a menos que se marque "dolor-ocular"
                if (!document.getElementById('dolor-ocular').checked) {
                    painSection.classList.add('hidden');
                }
            }
            
            updateDashboard();
            generateConclusion();
        }

        // L√≥gica para mostrar/ocultar secci√≥n de dolor
        function handlePainComplaint(checkbox) {
            const painSection = document.getElementById('pain-characteristics-section');
            if (checkbox.checked) {
                painSection.classList.remove('hidden');
            } else {
                painSection.classList.add('hidden');
                // Limpiar campos de dolor al ocultar
                document.getElementById('dolor-od-intensidad').value = 0;
                document.getElementById('dolor-oi-intensidad').value = 0;
                document.getElementById('dolor-od-value').textContent = '0';
                document.getElementById('dolor-oi-value').textContent = '0';
                document.querySelectorAll('input[name="tipo-dolor-ocular"]').forEach(radio => radio.checked = false);
            }
            updateDashboard();
            generateConclusion();
        }

        // üîó Sincronizaci√≥n de campos y resaltados
        function updateGlaucomaHighlights(checkbox) {
            const pioSection = document.getElementById('pressure-exam-section');
            const cupDiscInputs = document.querySelectorAll('#fundoscopy input[id^="cup-disc-"]');
            
            if (checkbox.checked) {
                pioSection.classList.add('warning-highlight'); // Agrega una clase para resaltar
                cupDiscInputs.forEach(input => {
                    input.style.borderColor = 'var(--warning-color)';
                    input.style.boxShadow = '0 0 5px rgba(243, 156, 18, 0.5)';
                });
            } else {
                pioSection.classList.remove('warning-highlight');
                cupDiscInputs.forEach(input => {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                });
            }
            updateDashboard();
            generateConclusion();
        }

        function updateDiabetesHighlights(checkbox) {
            const rdSection = document.querySelector('#scales .score-calculation:first-of-type'); // Retinopat√≠a Diab√©tica
            const retinaVesselsInputsOD = document.querySelectorAll('#fundoscopy input[id^="estrechamiento-arteriolar-od"], #fundoscopy input[id^="cruces-av-patologicos-od"], #fundoscopy input[id^="hemorragias-retinianas-od"], #fundoscopy input[id^="microaneurismas-od"], #fundoscopy input[id^="manchas-algodonosas-od"], #fundoscopy input[id^="neovascularizacion-retiniana-od"]');
            const retinaVesselsInputsOI = document.querySelectorAll('#fundoscopy input[id^="estrechamiento-arteriolar-oi"], #fundoscopy input[id^="cruces-av-patologicos-oi"], #fundoscopy input[id^="hemorragias-retinianas-oi"], #fundoscopy input[id^="microaneurismas-oi"], #fundoscopy input[id^="manchas-algodonosas-oi"], #fundoscopy input[id^="neovascularizacion-retiniana-oi"]');

            if (checkbox.checked) {
                rdSection.style.boxShadow = '0 0 8px rgba(243, 156, 18, 0.4)'; // Resaltar escala RD
                retinaVesselsInputsOD.forEach(input => {
                    input.style.backgroundColor = '#fff3cd'; // Fondo amarillo suave
                    input.style.border = '2px solid var(--warning-color)';
                });
                retinaVesselsInputsOI.forEach(input => {
                    input.style.backgroundColor = '#fff3cd';
                    input.style.border = '2px solid var(--warning-color)';
                });
            } else {
                rdSection.style.boxShadow = '';
                retinaVesselsInputsOD.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.border = '';
                });
                retinaVesselsInputsOI.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.border = '';
                });
            }
            updateDashboard();
            generateConclusion();
        }

        function updateHypertensionHighlights(checkbox) {
            const rhSection = document.querySelector('#scales .score-calculation:nth-of-type(2)'); // Retinopat√≠a Hipertensiva
            const retinaVesselsInputsOD = document.querySelectorAll('#fundoscopy input[id^="estrechamiento-arteriolar-od"], #fundoscopy input[id^="cruces-av-patologicos-od"], #fundoscopy input[id^="hemorragias-retinianas-od"]');
            const retinaVesselsInputsOI = document.querySelectorAll('#fundoscopy input[id^="estrechamiento-arteriolar-oi"], #fundoscopy input[id^="cruces-av-patologicos-oi"], #fundoscopy input[id^="hemorragias-retinianas-oi"]');

            if (checkbox.checked) {
                rhSection.style.boxShadow = '0 0 8px rgba(243, 156, 18, 0.4)'; // Resaltar escala RH
                retinaVesselsInputsOD.forEach(input => {
                    input.style.backgroundColor = '#fff3cd';
                    input.style.border = '2px solid var(--warning-color)';
                });
                retinaVesselsInputsOI.forEach(input => {
                    input.style.backgroundColor = '#fff3cd';
                    input.style.border = '2px solid var(--warning-color)';
                });
            } else {
                rhSection.style.boxShadow = '';
                retinaVesselsInputsOD.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.border = '';
                });
                retinaVesselsInputsOI.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.border = '';
                });
            }
            updateDashboard();
            generateConclusion();
        }
        
        // ‚öñÔ∏è Manejo de checkboxes mutuamente excluyentes
        function handleMutuallyExclusive(positiveId, negativeId, checkbox) {
            if (checkbox.checked) {
                const oppositeId = checkbox.id === positiveId ? negativeId : positiveId;
                const oppositeCheckbox = document.getElementById(oppositeId);
                if (oppositeCheckbox) oppositeCheckbox.checked = false;
            }
            updateDashboard();
            generateConclusion();
        }

        // üìä Actualizar valor del dolor
        function updateDolorValue(eye, value) {
            document.getElementById(`dolor-${eye}-value`).textContent = value;
            updateDashboard();
            generateConclusion();
        }

        function evaluateAVStatus(eye) {
            const avSC = document.getElementById(`av-lejos-${eye}-sc`).value;
            const avCC = document.getElementById(`av-lejos-${eye}-cc`).value;
            const avPH = document.getElementById(`av-lejos-${eye}-ph`).value;
            
            let status = '--';
            let isAbnormal = false;

            const toDecimal = (fraction) => {
                if (!fraction || !fraction.includes('/')) return 0;
                const parts = fraction.split('/');
                return parseFloat(parts[0]) / parseFloat(parts[1]);
            };

            const refNormal = toDecimal('20/20');
            const refBorderline = toDecimal('20/40');
            const refAbnormal = toDecimal('20/80');

            let decimalValue = 0;
            if (avCC) decimalValue = toDecimal(avCC);
            else if (avSC) decimalValue = toDecimal(avSC);

            if (decimalValue > 0) {
                if (decimalValue >= refNormal) {
                    status = 'Normal';
                } else if (decimalValue >= refBorderline) {
                    status = 'Reducida';
                    isAbnormal = true;
                } else {
                    status = 'Anormal';
                    isAbnormal = true;
                }
            } else if (avSC || avCC || avPH) { // Si hay alg√∫n valor pero no es interpretable num√©ricamente
                status = 'Registrado';
            }

            if (eye === 'od') {
                avODStatus = status;
                document.getElementById('av-od-status').textContent = status;
                document.getElementById('av-od-status').parentElement.className = `dashboard-item ${isAbnormal ? 'dashboard-alert' : 'dashboard-normal'}`;
            } else {
                avOIStatus = status;
                document.getElementById('av-oi-status').textContent = status;
                document.getElementById('av-oi-status').parentElement.className = `dashboard-item ${isAbnormal ? 'dashboard-alert' : 'dashboard-normal'}`;
            }
            updateDashboard();
        }

        function evaluatePIO() {
            const pioOD = parseFloat(document.getElementById('pio-od').value);
            const pioOI = parseFloat(document.getElementById('pio-oi').value);
            
            const pioScoreODEl = document.getElementById('interpretacion-pio-od');
            const pioScoreOIEl = document.getElementById('interpretacion-pio-oi');
            const pioSectionContainer = document.querySelector('#pressure-exam .score-calculation');

            function interpretPIO(pressure) {
                if (isNaN(pressure)) return '--';
                if (pressure <= 21) return 'Normal';
                if (pressure <= 25) return 'Borderline';
                if (pressure <= 30) return 'Elevada';
                return 'Muy elevada';
            }
            
            const interpretationOD = interpretPIO(pioOD);
            const interpretationOI = interpretPIO(pioOI);

            pioScoreODEl.textContent = interpretationOD;
            pioScoreOIEl.textContent = interpretationOI;

            pioSectionContainer.classList.remove('pio-normal', 'pio-borderline', 'pio-elevated', 'pio-very-elevated');
            let maxPioStatus = '';
            let isPioAbnormal = false;

            if (interpretationOD === 'Muy elevada' || interpretationOI === 'Muy elevada') { maxPioStatus = 'pio-very-elevated'; isPioAbnormal = true; }
            else if (interpretationOD === 'Elevada' || interpretationOI === 'Elevada') { maxPioStatus = 'pio-elevated'; isPioAbnormal = true; }
            else if (interpretationOD === 'Borderline' || interpretationOI === 'Borderline') { maxPioStatus = 'pio-borderline'; isPioAbnormal = true; }
            else if (interpretationOD === 'Normal' && interpretationOI === 'Normal' && (pioOD || pioOI)) { maxPioStatus = 'pio-normal'; }
            else if ((!isNaN(pioOD) && !pioOD) && (!isNaN(pioOI) && !pioOI)) { /* Ambos vac√≠os */ }
            else if ((!isNaN(pioOD) && pioOD) || (!isNaN(pioOI) && pioOI)) { /* Al menos uno tiene un valor */
                 if (interpretationOD === 'Normal' || interpretationOI === 'Normal') maxPioStatus = 'pio-normal';
            }
            
            if (maxPioStatus) {
                pioSectionContainer.classList.add(maxPioStatus);
            }

            pioODStatus = interpretationOD;
            pioOIStatus = interpretationOI;
            
            document.getElementById('pio-od-status').textContent = pioODStatus;
            document.getElementById('pio-od-status').parentElement.className = `dashboard-item ${isPioAbnormal ? 'dashboard-alert' : 'dashboard-normal'}`;
            document.getElementById('pio-oi-status').textContent = pioOIStatus;
            document.getElementById('pio-oi-status').parentElement.className = `dashboard-item ${isPioAbnormal ? 'dashboard-alert' : 'dashboard-normal'}`;

            updateDashboard();
            generateConclusion();
        }

        function evaluateCupDisc(eye) {
            const ratio = parseFloat(document.getElementById(`cup-disc-${eye}`).value);
            
            function interpretCupDisc(ratio) {
                if (isNaN(ratio)) return '--';
                if (ratio <= 0.3) return 'Normal';
                if (ratio <= 0.6) return 'Borderline';
                return 'Sospechoso glaucoma';
            }
            
            document.getElementById(`interpretacion-cd-${eye}`).textContent = interpretCupDisc(ratio);
            updateDashboard();
            generateConclusion();
        }

        function calculateVisualDisability() {
            const bestEyeAV = document.getElementById('mejor-ojo-av').value;
            
            function interpretVisualDisability(av) {
                if (!av) return '--';
                
                let decimal;
                if (av.includes('/')) {
                    const parts = av.split('/');
                    const num = parseInt(parts[0]);
                    const den = parseInt(parts[1]);
                    if (isNaN(num) || isNaN(den) || den === 0) return 'Formato inv√°lido';
                    decimal = num / den;
                } else if (parseFloat(av)) { // Si es un n√∫mero decimal directo (ej. 0.5)
                    decimal = parseFloat(av);
                } else {
                    return 'Formato inv√°lido';
                }
                
                // Conversi√≥n a escala Snellen decimal para OMS (aprox)
                // 20/20 = 1.0, 20/70 = 0.28, 20/200 = 0.1, 20/400 = 0.05, 3/60 = 0.05
                // Las categor√≠as de la OMS se basan en la mejor agudeza visual con la mejor correcci√≥n posible
                // Ojo: Las clasificaciones de la OMS son m√°s complejas, esta es una simplificaci√≥n.
                // Categor√≠as de la OMS (Clasificaci√≥n 2003):
                // Visi√≥n Normal: AV ‚â• 0.5 (equivalente a 20/40)
                // Baja Visi√≥n Moderada: AV < 0.5 a ‚â• 0.1 (equiv. 20/40 a 20/200)
                // Baja Visi√≥n Severa: AV < 0.1 a ‚â• 0.05 (equiv. 20/200 a 20/400)
                // Ceguera: AV < 0.05 (equiv. < 20/400 o < 3/60)

                if (decimal >= 0.5) return 'Visi√≥n normal';
                if (decimal >= 0.1) return 'Baja visi√≥n moderada';
                if (decimal >= 0.05) return 'Baja visi√≥n severa';
                if (decimal < 0.05) return 'Ceguera';
                return '--';
            }
            
            document.getElementById('clasificacion-oms').textContent = interpretVisualDisability(bestEyeAV);
            updateDashboard();
            generateConclusion();
        }

        function calculateVFQ() {
            let score = 0;
            const vfqItems = [
                'vfq-vision-general', 'vfq-actividades-cerca', 'vfq-actividades-lejos',
                'vfq-vision-social', 'vfq-salud-mental', 'vfq-dependencia',
                'vfq-conducir', 'vfq-color', 'vfq-vision-periferica'
            ];
            
            vfqItems.forEach(item => {
                if (document.getElementById(item).checked) {
                    score++;
                }
            });
            
            document.getElementById('vfq-score').textContent = score;
            updateDashboard();
            generateConclusion();
        }

        // üìä ACTUALIZAR DASHBOARD
        function updateDashboard() {
            const sections = [
                'anamnesis', 'visual-acuity', 'pupil-exam', 'external-exam', 
                'motility-exam', 'anterior-segment', 'pressure-exam', 'fundoscopy', 'scales'
            ];
            
            let currentCompletedSections = 0;
            let currentTotalFindings = 0;
            let currentTotalAlerts = 0;
            let currentTotalWarnings = 0;
            
            sections.forEach(sectionId => {
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) {
                    const checkboxes = sectionElement.querySelectorAll('input[type="checkbox"]:checked');
                    const radios = sectionElement.querySelectorAll('input[type="radio"]:checked');
                    const numbers = sectionElement.querySelectorAll('input[type="number"]');
                    const texts = sectionElement.querySelectorAll('input[type="text"]');
                    const selects = sectionElement.querySelectorAll('select');
                    
                    let hasContent = checkboxes.length > 0 || radios.length > 0;
                    
                    numbers.forEach(input => {
                        if (input.value && !isNaN(input.value) && parseFloat(input.value) !== 0) hasContent = true;
                    });
                    texts.forEach(input => {
                        if (input.value && input.value.trim() !== '') hasContent = true;
                    });
                    selects.forEach(select => {
                        if (select.value && select.value.trim() !== '') hasContent = true;
                    });

                    // Si la secci√≥n es anamnesis y "sin quejas" est√° marcado, se considera completada.
                    if (sectionId === 'anamnesis' && document.getElementById('sin-quejas-oftalmo')?.checked) {
                        hasContent = true;
                    }
                    
                    if (hasContent) {
                        currentCompletedSections++;
                        currentTotalFindings += checkboxes.length + radios.length + Array.from(numbers).filter(n => n.value).length + Array.from(texts).filter(t => t.value).length + Array.from(selects).filter(s => s.value).length;
                        
                        const badge = document.getElementById(`badge-${sectionId}`);
                        const navItem = document.getElementById(`nav-${sectionId}`);
                        
                        if (badge) {
                            badge.classList.add('completed');
                            badge.innerHTML = '<i class="fas fa-check"></i>';
                        }
                        
                        if (navItem) {
                            navItem.style.opacity = '1';
                            navItem.parentElement.classList.add('completed');
                        }
                        
                        // Contar alertas y warnings espec√≠ficos de Oftalmo
                        checkboxes.forEach(checkbox => {
                            const label = checkbox.nextElementSibling ? checkbox.nextElementSibling.textContent.toLowerCase() : '';
                            
                            // Criterios de alerta para oftalmolog√≠a
                            if (checkbox.id.includes('perdida-vision') || checkbox.id.includes('ceguera') ||
                                checkbox.id.includes('papiledema') || checkbox.id.includes('hemorragia-vitrea') ||
                                checkbox.id.includes('desprendimiento-retina') || checkbox.id.includes('ulcera') ||
                                checkbox.id.includes('hipopion') || checkbox.id.includes('hifema') ||
                                checkbox.id.includes('celulas-od') || checkbox.id.includes('celulas-oi') || // C√©lulas inflamatorias
                                checkbox.id.includes('flare-od') || checkbox.id.includes('flare-oi') ||
                                checkbox.id.includes('marcus-gunn-pos') || checkbox.id.includes('nistagmo-presente') ||
                                checkbox.id.includes('escleritis') || checkbox.id.includes('dacriocistitis') ||
                                (checkbox.id.includes('av-lejos') && (label.includes('no percepci√≥n de luz') || label.includes('movimiento de manos'))) ||
                                (checkbox.id.includes('pio-') && (parseFloat(checkbox.value) > 30)) || // PIO muy elevada
                                (checkbox.id.includes('cup-disc-') && (parseFloat(checkbox.value) > 0.7)) // C/D muy alta
                            ) {
                                currentTotalAlerts++;
                            }
                            // Criterios de warning
                            else if (checkbox.id.includes('dolor-ocular') || checkbox.id.includes('vision-borrosa') ||
                                     checkbox.id.includes('diplopia') || checkbox.id.includes('fotofobia') ||
                                     checkbox.id.includes('ojo-rojo') || checkbox.id.includes('catarata-') ||
                                     checkbox.id.includes('excavacion-aumentada') || checkbox.id.includes('degeneracion-macular') ||
                                     checkbox.id.includes('edema-macular') || checkbox.id.includes('neovascularizacion') ||
                                     checkbox.id.includes('estrechamiento-arteriolar') || checkbox.id.includes('cruces-av-patologicos') ||
                                     checkbox.id.includes('hemorragias-retinianas') || checkbox.id.includes('microaneurismas') ||
                                     checkbox.id.includes('manchas-algodonosas') || checkbox.id.includes('drusas-') ||
                                     (checkbox.id.includes('pio-') && (parseFloat(checkbox.value) > 21 && parseFloat(checkbox.value) <= 30)) || // PIO elevada/borderline
                                     (checkbox.id.includes('cup-disc-') && (parseFloat(checkbox.value) > 0.3 && parseFloat(checkbox.value) <= 0.7)) || // C/D borderline
                                     (checkbox.id.includes('limitacion-') && checkbox.id.includes('aduccion')) || // Limitaci√≥n de movimientos
                                     checkbox.id.includes('hiperemia-conjuntival') || checkbox.id.includes('quemosis') ||
                                     checkbox.id.includes('ptosism') || checkbox.id.includes('ectropion') || checkbox.id.includes('entropion') ||
                                     checkbox.id.includes('triquiasis') || checkbox.id.includes('distiquiasis') || checkbox.id.includes('madarosis') ||
                                     checkbox.id.includes('dacrioadenitis') || checkbox.id.includes('epifora')
                            ) {
                                currentTotalWarnings++;
                            }
                        });
                        // Ajustar warnings/alerts de AV y PIO
                        if (avODStatus === 'Anormal' || avOIStatus === 'Anormal' || avODStatus === 'Ceguera' || avOIStatus === 'Ceguera') currentTotalAlerts++;
                        else if (avODStatus === 'Reducida' || avOIStatus === 'Reducida') currentTotalWarnings++;

                        if (pioODStatus === 'Muy elevada' || pioOIStatus === 'Muy elevada') currentTotalAlerts++;
                        else if (pioODStatus === 'Elevada' || pioOIStatus === 'Elevada' || pioODStatus === 'Borderline' || pioOIStatus === 'Borderline') currentTotalWarnings++;

                    } else {
                        const badge = document.getElementById(`badge-${sectionId}`);
                        const navItem = document.getElementById(`nav-${sectionId}`);
                        
                        if (badge) {
                            badge.classList.remove('completed');
                            badge.innerHTML = '<i class="fas fa-circle"></i>';
                        }
                        
                        if (navItem) {
                            navItem.style.opacity = '0';
                            navItem.parentElement.classList.remove('completed');
                        }
                    }
                }
            });
            
            examProgress = Math.round((currentCompletedSections / sections.length) * 100);
            document.getElementById('exam-progress').textContent = `${examProgress}%`;
            document.getElementById('sections-completed').textContent = `${currentCompletedSections}/${sections.length}`;
            document.getElementById('alert-count').textContent = currentTotalAlerts;
            document.getElementById('warning-count').textContent = currentTotalWarnings;
            document.getElementById('findings-count').textContent = currentTotalFindings;
            
            // Actualizar clases del dashboard seg√∫n alertas y warnings
            document.getElementById('alerts-item').className = `dashboard-item ${currentTotalAlerts > 0 ? 'dashboard-alert' : ''}`;
            document.getElementById('warnings-item').className = `dashboard-item ${currentTotalWarnings > 0 ? 'dashboard-warning' : ''}`;
            document.getElementById('findings-item').className = `dashboard-item ${currentTotalFindings > 0 ? 'dashboard-normal' : ''}`;

            alertCount = currentTotalAlerts; // Guardar para la conclusi√≥n
            warningCount = currentTotalWarnings;
            findingsCount = currentTotalFindings;
        }


        // üìù GENERAR CONCLUSI√ìN MEJORADA (Estilo narrativo y completo)
        function generateConclusion() {
            const conclusionEl = document.getElementById('conclusion-text');
            let conclusion = 'INFORME DEL EXAMEN OFTALMOL√ìGICO:\n\n';

            // Funciones auxiliares para simplificar el c√≥digo y la legibilidad
            const getLabelText = (id) => document.querySelector(`label[for="${id}"]`)?.textContent.toLowerCase() || '';
            const isChecked = (id) => document.getElementById(id)?.checked;
            const getInputValue = (id) => document.getElementById(id)?.value;
            const getSelectedValue = (id) => document.getElementById(id)?.value;
            const getSelectedText = (id) => {
                const select = document.getElementById(id);
                return select && select.selectedIndex > -1 ? select.options[select.selectedIndex].textContent.toLowerCase() : '';
            };
            const capitalizeFirstLetter = (string) => string.charAt(0).toUpperCase() + string.slice(1);
            const getRadioButtonValue = (name) => {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                return radio ? getLabelText(radio.id) : '';
            };
            // Funci√≥n para formatear listas de hallazgos
            const formatList = (arr) => {
                if (arr.length === 0) return '';
                if (arr.length === 1) return arr[0];
                const last = arr.pop();
                return arr.join(', ') + ' y ' + last;
            };


            // --- 1. ANAMNESIS Y QUEJAS PRINCIPALES ---
            let anamnesisAdded = false;
            let quejasText = '';
            const quejas = [];
            const noQuejasMarcado = isChecked('sin-quejas-oftalmo');

            if (noQuejasMarcado) {
                quejas.push('el paciente no refiere quejas oftalmol√≥gicas');
            } else {
                ['dolor-ocular', 'vision-borrosa', 'perdida-vision', 'diplopia', 'fotofobia',
                 'lagrimeo', 'ojo-seco', 'secrecion-ocular', 'prurito-ocular', 'sensacion-cuerpo-extrano',
                 'halos-visuales', 'destellos-luz', 'moscas-volantes', 'ceguera-nocturna',
                 'perdida-campo-visual', 'metamorfopsia', 'cefalea', 'ptosis-palpebral', 'ojo-rojo'].forEach(id => {
                    if (isChecked(id)) {
                        quejas.push(getLabelText(id));
                    }
                });
            }
            
            if (quejas.length > 0) {
                anamnesisAdded = true;
                quejasText += `El paciente consulta por ${formatList(quejas)}. `;

                // Caracter√≠sticas del Dolor Ocular
                const dolorOcularOD = getInputValue('dolor-od-intensidad');
                const dolorOcularOI = getInputValue('dolor-oi-intensidad');
                const tipoDolorOcular = getRadioButtonValue('tipo-dolor-ocular');

                let dolorOcularDetalle = '';
                if (dolorOcularOD && dolorOcularOD !== '0') dolorOcularDetalle += `Ojo derecho: ${dolorOcularOD}/10. `;
                if (dolorOcularOI && dolorOcularOI !== '0') dolorOcularDetalle += `Ojo izquierdo: ${dolorOcularOI}/10. `;
                if (tipoDolorOcular) dolorOcularDetalle += `Tipo de dolor: ${tipoDolorOcular}. `;
                
                if (dolorOcularDetalle) quejasText += `Caracter√≠sticas del dolor ocular: ${dolorOcularDetalle.trim()}. `;
            }

            // Historia Ocular y Antecedentes
            const antecedentesOftalmo = [];
            ['uso-lentes', 'cirugia-ocular-previa', 'trauma-ocular', 'glaucoma-familiar',
             'diabetes', 'hipertension', 'medicamentos-oftalmicos', 'corticoides-topicos'].forEach(id => {
                if (isChecked(id)) antecedentesOftalmo.push(getLabelText(id));
            });
            const factoresRiesgo = [];
            ['exposicion-uv', 'trabajo-computadora', 'exposicion-quimicos', 'soldadura',
             'miop√≠a-alta', 'edad-avanzada'].forEach(id => {
                if (isChecked(id)) factoresRiesgo.push(getLabelText(id));
            });

            if (antecedentesOftalmo.length > 0 || factoresRiesgo.length > 0) {
                anamnesisAdded = true;
                let historiaOcularText = '';
                if (antecedentesOftalmo.length > 0) {
                    historiaOcularText += `Antecedentes oftalmol√≥gicos: Se reporta ${formatList(antecedentesOftalmo)}. `;
                }
                if (factoresRiesgo.length > 0) {
                    historiaOcularText += `Factores de riesgo: Incluyen ${formatList(factoresRiesgo)}. `;
                }
                if (historiaOcularText) quejasText += `Historia ocular: ${historiaOcularText.trim()}. `;
            }
            
            if (anamnesisAdded) {
                conclusion += `ANAMNESIS Y QUEJAS PRINCIPALES:\n${quejasText.trim()}\n\n`;
            }

            // --- 2. EXAMEN DE AGUDEZA VISUAL ---
            let agudezaVisualAdded = false;
            let agudezaVisualText = '';

            // Agudeza Visual de Lejos
            const avLejosODSC = getInputValue('av-lejos-od-sc');
            const avLejosODCC = getInputValue('av-lejos-od-cc');
            const avLejosODPH = getInputValue('av-lejos-od-ph');
            const avLejosOISC = getInputValue('av-lejos-oi-sc');
            const avLejosOICC = getInputValue('av-lejos-oi-cc');
            const avLejosOIPH = getInputValue('av-lejos-oi-ph');
            
            if (avLejosODSC || avLejosODCC || avLejosODPH || avLejosOISC || avLejosOICC || avLejosOIPH) {
                agudezaVisualAdded = true;
                agudezaVisualText += `Agudeza Visual de Lejos (6 metros): `;
                let odDetails = [];
                if (avLejosODSC) odDetails.push(`OD s/c: ${avLejosODSC}`);
                if (avLejosODCC) odDetails.push(`c/c: ${avLejosODCC}`);
                if (avLejosODPH) odDetails.push(`AE: ${avLejosODPH}`);
                if (odDetails.length > 0) agudezaVisualText += `Ojo Derecho: ${odDetails.join(', ')}. `;

                let oiDetails = [];
                if (avLejosOISC) oiDetails.push(`OI s/c: ${avLejosOISC}`);
                if (avLejosOICC) oiDetails.push(`c/c: ${avLejosOICC}`);
                if (avLejosOIPH) oiDetails.push(`AE: ${avLejosOIPH}`);
                if (oiDetails.length > 0) agudezaVisualText += `Ojo Izquierdo: ${oiDetails.join(', ')}. `;
            }

            // Agudeza Visual de Cerca
            const avCercaODSC = getInputValue('av-cerca-od-sc');
            const avCercaODCC = getInputValue('av-cerca-od-cc');
            const avCercaOISC = getInputValue('av-cerca-oi-sc');
            const avCercaOICC = getInputValue('av-cerca-oi-cc');

            if (avCercaODSC || avCercaODCC || avCercaOISC || avCercaOICC) {
                agudezaVisualAdded = true;
                agudezaVisualText += `Agudeza Visual de Cerca (40 cm): `;
                let odCercaDetails = [];
                if (avCercaODSC) odCercaDetails.push(`OD s/c: ${avCercaODSC}`);
                if (avCercaODCC) odCercaDetails.push(`c/c: ${avCercaODCC}`);
                if (odCercaDetails.length > 0) agudezaVisualText += `Ojo Derecho: ${odCercaDetails.join(', ')}. `;

                let oiCercaDetails = [];
                if (avCercaOISC) oiCercaDetails.push(`OI s/c: ${avCercaOISC}`);
                if (avCercaOICC) oiCercaDetails.push(`c/c: ${avCercaOICC}`);
                if (oiCercaDetails.length > 0) agudezaVisualText += `Ojo Izquierdo: ${oiCercaDetails.join(', ')}. `;
            }

            // Evaluaci√≥n de Campo Visual
            const fieldDefectsOD = Array.from(document.querySelectorAll('#visual-acuity .eye-field:nth-of-type(1) .field-quadrant.defect')).map(q => q.textContent.trim());
            const fieldDefectsOI = Array.from(document.querySelectorAll('#visual-acuity .eye-field:nth-of-type(2) .field-quadrant.defect')).map(q => q.textContent.trim());
            const campoVisualTipos = [];
            ['hemianopsia-hom√≥nima', 'hemianopsia-heteronima', 'cuadrantanopsia', 'escotoma-central',
             'escotoma-paracentral', 'defecto-altitudinal', 'constriccion-concentrica'].forEach(id => {
                if (isChecked(id)) campoVisualTipos.push(getLabelText(id));
            });
            const campoVisualNormal = isChecked('campo-normal');

            if (fieldDefectsOD.length > 0 || fieldDefectsOI.length > 0 || campoVisualTipos.length > 0 || campoVisualNormal) {
                agudezaVisualAdded = true;
                agudezaVisualText += `Campo Visual por Confrontaci√≥n: `;
                if (campoVisualNormal) {
                    agudezaVisualText += `Campo visual normal en ambos ojos. `;
                } else {
                    if (fieldDefectsOD.length > 0) {
                        agudezaVisualText += `Ojo Derecho con defecto en ${formatList(fieldDefectsOD)}. `;
                    } else {
                         agudezaVisualText += `Campo visual de Ojo Derecho sin defectos por confrontaci√≥n. `;
                    }
                    if (fieldDefectsOI.length > 0) {
                        agudezaVisualText += `Ojo Izquierdo con defecto en ${formatList(fieldDefectsOI)}. `;
                    } else {
                        agudezaVisualText += `Campo visual de Ojo Izquierdo sin defectos por confrontaci√≥n. `;
                    }
                    if (campoVisualTipos.length > 0) {
                        agudezaVisualText += `Tipo de defecto campim√©trico: ${formatList(campoVisualTipos)}. `;
                    } else if (fieldDefectsOD.length === 0 && fieldDefectsOI.length === 0) {
                        agudezaVisualText += 'No se identifican defectos campim√©tricos por confrontaci√≥n. ';
                    }
                }
            }

            // Visi√≥n de Colores
            const ishiharaODNormal = isChecked('ishihara-od-normal');
            const ishiharaODAlterado = isChecked('ishihara-od-alterado');
            const ishiharaODScore = getInputValue('ishihara-od-score');
            const ishiharaOINormal = isChecked('ishihara-oi-normal');
            const ishiharaOIAlterado = isChecked('ishihara-oi-alterado');
            const ishiharaOIScore = getInputValue('ishihara-oi-score');
            const tipoDiscromatopsia = getRadioButtonValue('tipo-discromatopsia');

            if (ishiharaODNormal || ishiharaODAlterado || ishiharaOINormal || ishiharaOIAlterado || tipoDiscromatopsia) {
                agudezaVisualAdded = true;
                agudezaVisualText += `Visi√≥n de Colores (Test de Ishihara): `;
                if (ishiharaODNormal) agudezaVisualText += `OD: Normal. `;
                else if (ishiharaODAlterado) agudezaVisualText += `OD: Alterado${ishiharaODScore ? ` (Puntuaci√≥n: ${ishiharaODScore})` : ''}. `;
                else if (ishiharaODScore) agudezaVisualText += `OD: Sin estado marcado, puntuaci√≥n ${ishiharaODScore}. `;

                if (ishiharaOINormal) agudezaVisualText += `OI: Normal. `;
                else if (ishiharaOIAlterado) agudezaVisualText += `OI: Alterado${ishiharaOIScore ? ` (Puntuaci√≥n: ${ishiharaOIScore})` : ''}. `;
                else if (ishiharaOIScore) agudezaVisualText += `OI: Sin estado marcado, puntuaci√≥n ${ishiharaOIScore}. `;

                if (tipoDiscromatopsia) agudezaVisualText += `Tipo de discromatopsia: ${tipoDiscromatopsia}. `;
            } else if (ishiharaODScore || ishiharaOIScore) { // Si solo hay puntuaci√≥n sin estado
                agudezaVisualAdded = true;
                agudezaVisualText += `Visi√≥n de Colores (Test de Ishihara): OD Puntuaci√≥n: ${ishiharaODScore || 'N/A'}, OI Puntuaci√≥n: ${ishiharaOIScore || 'N/A'}. `;
            }


            if (agudezaVisualAdded) {
                conclusion += `AGUDEZA VISUAL Y CAMPO VISUAL:\n${agudezaVisualText.trim()}\n\n`;
            }

            // --- 3. EXAMEN PUPILAR ---
            let pupilExamAdded = false;
            let pupilExamText = '';

            // Tama√±o y Forma Pupilar
            const pupilaODLuz = getInputValue('pupila-od-luz');
            const pupilaODOscuridad = getInputValue('pupila-od-oscuridad');
            const formaOD = getRadioButtonValue('forma-od');
            const pupilaOILuz = getInputValue('pupila-oi-luz');
            const pupilaOIOscuridad = getInputValue('pupila-oi-oscuridad');
            const formaOI = getRadioButtonValue('forma-oi');

            if (pupilaODLuz || pupilaODOscuridad || formaOD || pupilaOILuz || pupilaOIOscuridad || formaOI) {
                pupilExamAdded = true;
                let odPupilDetails = [];
                if (pupilaODLuz) odPupilDetails.push(`tama√±o en luz: ${pupilaODLuz}mm`);
                if (pupilaODOscuridad) odPupilDetails.push(`en oscuridad: ${pupilaODOscuridad}mm`);
                if (formaOD) odPupilDetails.push(`forma: ${formaOD}`);
                if (odPupilDetails.length > 0) pupilExamText += `Ojo Derecho: ${formatList(odPupilDetails)}. `;

                let oiPupilDetails = [];
                if (pupilaOILuz) oiPupilDetails.push(`tama√±o en luz: ${pupilaOILuz}mm`);
                if (pupilaOIOscuridad) oiPupilDetails.push(`en oscuridad: ${pupilaOIOscuridad}mm`);
                if (formaOI) oiPupilDetails.push(`forma: ${formaOI}`);
                if (oiPupilDetails.length > 0) pupilExamText += `Ojo Izquierdo: ${formatList(oiPupilDetails)}. `;
            }

            // Reflejos Pupilares
            const reflejosPupilares = [];
            // Reflejo fotomotor directo OD
            if (isChecked('fotomotor-directo-od-pos')) reflejosPupilares.push('Reflejo fotomotor directo OD: Presente');
            else if (isChecked('fotomotor-directo-od-neg')) reflejosPupilares.push('Reflejo fotomotor directo OD: Ausente');
            // Reflejo fotomotor directo OI
            if (isChecked('fotomotor-directo-oi-pos')) reflejosPupilares.push('Reflejo fotomotor directo OI: Presente');
            else if (isChecked('fotomotor-directo-oi-neg')) reflejosPupilares.push('Reflejo fotomotor directo OI: Ausente');
            // Reflejo consensual OD -> OI
            if (isChecked('consensual-od-oi-pos')) reflejosPupilares.push('Reflejo consensual OD ‚Üí OI: Presente');
            else if (isChecked('consensual-od-oi-neg')) reflejosPupilares.push('Reflejo consensual OD ‚Üí OI: Ausente');
            // Reflejo consensual OI -> OD
            if (isChecked('consensual-oi-od-pos')) reflejosPupilares.push('Reflejo consensual OI ‚Üí OD: Presente');
            else if (isChecked('consensual-oi-od-neg')) reflejosPupilares.push('Reflejo consensual OI ‚Üí OD: Ausente');
            // Test de Marcus Gunn (DPAR)
            const marcusGunnOjo = getSelectedValue('marcus-gunn-ojo');
            if (isChecked('marcus-gunn-pos')) reflejosPupilares.push(`Test de Marcus Gunn (DPAR): Positivo en ojo ${marcusGunnOjo.toUpperCase()}`);
            else if (isChecked('marcus-gunn-neg')) reflejosPupilares.push('Test de Marcus Gunn (DPAR): Negativo');
            else if (marcusGunnOjo && marcusGunnOjo !== '') reflejosPupilares.push(`Test de Marcus Gunn (DPAR): Ojo ${marcusGunnOjo.toUpperCase()} seleccionado, pero sin resultado de prueba.`);
            // Reflejo de acomodaci√≥n
            if (isChecked('acomodacion-normal')) reflejosPupilares.push('Reflejo de acomodaci√≥n: Normal');
            else if (isChecked('acomodacion-alterado')) reflejosPupilares.push('Reflejo de acomodaci√≥n: Alterado');

            if (reflejosPupilares.length > 0) {
                pupilExamAdded = true;
                pupilExamText += `Reflejos pupilares: ${reflejosPupilares.join('; ')}. `;
            }

            if (pupilExamAdded) {
                conclusion += `EXAMEN PUPILAR:\n${pupilExamText.trim()}\n\n`;
            }

            // --- 4. EXAMEN EXTERNO DEL OJO ---
            let externalExamAdded = false;
            let externalExamText = '';

            // P√°rpados OD
            const parpadosODSup = []; ['ptosis-od', 'retraccion-od', 'edema-od', 'eritema-od', 'lesion-od'].forEach(id => { if (isChecked(id)) parpadosODSup.push(getLabelText(id)); });
            const hendiduraOD = getInputValue('hendidura-od');
            const parpadosODInf = []; ['ectropion-od', 'entropion-od', 'bolsas-od'].forEach(id => { if (isChecked(id)) parpadosODInf.push(getLabelText(id)); });
            const pestanasOD = []; ['triquiasis-od', 'distiquiasis-od', 'madarosis-od'].forEach(id => { if (isChecked(id)) pestanasOD.push(getLabelText(id)); });

            // P√°rpados OI
            const parpadosOISup = []; ['ptosis-oi', 'retraccion-oi', 'edema-oi', 'eritema-oi', 'lesion-oi'].forEach(id => { if (isChecked(id)) parpadosOISup.push(getLabelText(id)); });
            const hendiduraOI = getInputValue('hendidura-oi');
            const parpadosOIInf = []; ['ectropion-oi', 'entropion-oi', 'bolsas-oi'].forEach(id => { if (isChecked(id)) parpadosOIInf.push(getLabelText(id)); });
            const pestanasOI = []; ['triquiasis-oi', 'distiquiasis-oi', 'madarosis-oi'].forEach(id => { if (isChecked(id)) pestanasOI.push(getLabelText(id)); });

            // P√°rpados OD
            let odParpadosSectionText = '';
            const allODParpadosNormal = isChecked('parpado-sup-od-normal') && parpadosODSup.length === 0 &&
                                         isChecked('parpado-inf-od-normal') && parpadosODInf.length === 0 &&
                                         isChecked('pestanas-od-normales') && pestanasOD.length === 0;

            if (allODParpadosNormal) {
                odParpadosSectionText += 'Ojo Derecho: P√°rpados y pesta√±as normales. ';
            } else if (isChecked('parpado-sup-od-normal') || parpadosODSup.length > 0 || hendiduraOD || isChecked('parpado-inf-od-normal') || parpadosODInf.length > 0 || isChecked('pestanas-od-normales') || pestanasOD.length > 0) {
                externalExamAdded = true; // Solo a√±adir si hay algo que reportar
                odParpadosSectionText += 'Ojo Derecho: ';
                if (isChecked('parpado-sup-od-normal')) odParpadosSectionText += 'P√°rpado superior normal. ';
                else if (parpadosODSup.length > 0) odParpadosSectionText += `P√°rpado superior: ${formatList(parpadosODSup)}. `;
                if (hendiduraOD) odParpadosSectionText += `Hendidura palpebral: ${hendiduraOD} mm. `;
                if (isChecked('parpado-inf-od-normal')) odParpadosSectionText += 'P√°rpado inferior normal. ';
                else if (parpadosODInf.length > 0) odParpadosSectionText += `P√°rpado inferior: ${formatList(parpadosODInf)}. `;
                if (isChecked('pestanas-od-normales')) odParpadosSectionText += 'Pesta√±as normales. ';
                else if (pestanasOD.length > 0) odParpadosSectionText += `Pesta√±as: ${formatList(pestanasOD)}. `;
            }

            // P√°rpados OI
            let oiParpadosSectionText = '';
            const allOIParpadosNormal = isChecked('parpado-sup-oi-normal') && parpadosOISup.length === 0 &&
                                         isChecked('parpado-inf-oi-normal') && parpadosOIInf.length === 0 &&
                                         isChecked('pestanas-oi-normales') && pestanasOI.length === 0;

            if (allOIParpadosNormal) {
                oiParpadosSectionText += 'Ojo Izquierdo: P√°rpados y pesta√±as normales. ';
            } else if (isChecked('parpado-sup-oi-normal') || parpadosOISup.length > 0 || hendiduraOI || isChecked('parpado-inf-oi-normal') || parpadosOIInf.length > 0 || isChecked('pestanas-oi-normales') || pestanasOI.length > 0) {
                externalExamAdded = true; // Solo a√±adir si hay algo que reportar
                oiParpadosSectionText += 'Ojo Izquierdo: ';
                if (isChecked('parpado-sup-oi-normal')) oiParpadosSectionText += 'P√°rpado superior normal. ';
                else if (parpadosOISup.length > 0) oiParpadosSectionText += `P√°rpado superior: ${formatList(parpadosOISup)}. `;
                if (hendiduraOI) oiParpadosSectionText += `Hendidura palpebral: ${hendiduraOI} mm. `;
                if (isChecked('parpado-inf-oi-normal')) oiParpadosSectionText += 'P√°rpado inferior normal. ';
                else if (parpadosOIInf.length > 0) oiParpadosSectionText += `P√°rpado inferior: ${formatList(parpadosOIInf)}. `;
                if (isChecked('pestanas-oi-normales')) oiParpadosSectionText += 'Pesta√±as normales. ';
                else if (pestanasOI.length > 0) oiParpadosSectionText += `Pesta√±as: ${formatList(pestanasOI)}. `;
            }
            if (odParpadosSectionText || oiParpadosSectionText) {
                externalExamText += `P√°rpados: ${odParpadosSectionText.trim()} ${oiParpadosSectionText.trim()}. `;
            }


            // Aparato Lagrimal
            const glandulaLagrimalOD = []; ['dacrioadenitis-od', 'masa-lagrimal-od'].forEach(id => { if (isChecked(id)) glandulaLagrimalOD.push(getLabelText(id)); });
            const viaLagrimalOD = []; ['epifora-od', 'dacriocistitis-od', 'mucocele-od'].forEach(id => { if (isChecked(id)) viaLagrimalOD.push(getLabelText(id)); });
            const glandulaLagrimalOI = []; ['dacrioadenitis-oi', 'masa-lagrimal-oi'].forEach(id => { if (isChecked(id)) glandulaLagrimalOI.push(getLabelText(id)); });
            const viaLagrimalOI = []; ['epifora-oi', 'dacriocistitis-oi', 'mucocele-oi'].forEach(id => { if (isChecked(id)) viaLagrimalOI.push(getLabelText(id)); });
            
            let odLagrimalText = '';
            const allODLagrimalNormal = isChecked('glandula-lagrimal-od-normal') && glandulaLagrimalOD.length === 0 &&
                                        isChecked('via-lagrimal-od-normal') && viaLagrimalOD.length === 0;

            if (allODLagrimalNormal) {
                odLagrimalText += 'OD: Sistema lagrimal normal. ';
            } else if (glandulaLagrimalOD.length > 0 || viaLagrimalOD.length > 0) {
                externalExamAdded = true;
                odLagrimalText += `OD: Gl√°ndula lagrimal ${formatList(glandulaLagrimalOD)}, V√≠a lagrimal ${formatList(viaLagrimalOD)}. `;
            }

            let oiLagrimalText = '';
            const allOILagrimalNormal = isChecked('glandula-lagrimal-oi-normal') && glandulaLagrimalOI.length === 0 &&
                                        isChecked('via-lagrimal-oi-normal') && viaLagrimalOI.length === 0;

            if (allOILagrimalNormal) {
                oiLagrimalText += 'OI: Sistema lagrimal normal. ';
            } else if (glandulaLagrimalOI.length > 0 || viaLagrimalOI.length > 0) {
                externalExamAdded = true;
                oiLagrimalText += `OI: Gl√°ndula lagrimal ${formatList(glandulaLagrimalOI)}, V√≠a lagrimal ${formatList(viaLagrimalOI)}. `;
            }

            if (odLagrimalText || oiLagrimalText) {
                externalExamText += `Aparato Lagrimal: ${odLagrimalText.trim()} ${oiLagrimalText.trim()}. `;
            }
            

            // Conjuntiva y Esclera
            const conjBulbarOD = []; ['hiperemia-conjuntival-od', 'quemosis-od', 'hemorragia-subconjuntival-od', 'pinguecula-od', 'pterigion-od'].forEach(id => { if (isChecked(id)) conjBulbarOD.push(getLabelText(id)); });
            const conjPalpebralOD = []; ['fol√≠culos-od', 'papilas-od', 'cicatrices-od'].forEach(id => { if (isChecked(id)) conjPalpebralOD.push(getLabelText(id)); });
            const escleraOD = []; ['escleritis-od', 'epiescleritis-od', 'ictericia-escleral-od'].forEach(id => { if (isChecked(id)) escleraOD.push(getLabelText(id)); });

            const conjBulbarOI = []; ['hiperemia-conjuntival-oi', 'quemosis-oi', 'hemorragia-subconjuntival-oi', 'pinguecula-oi', 'pterigion-oi'].forEach(id => { if (isChecked(id)) conjBulbarOI.push(getLabelText(id)); });
            const conjPalpebralOI = []; ['fol√≠culos-oi', 'papilas-oi', 'cicatrices-oi'].forEach(id => { if (isChecked(id)) conjPalpebralOI.push(getLabelText(id)); });
            const escleraOI = []; ['escleritis-oi', 'epiescleritis-oi', 'ictericia-escleral-oi'].forEach(id => { if (isChecked(id)) escleraOI.push(getLabelText(id)); });

            let odConjEscleraText = '';
            const allODConjEscleraNormal = isChecked('conjuntiva-bulbar-od-normal') && conjBulbarOD.length === 0 &&
                                            isChecked('conjuntiva-palpebral-od-normal') && conjPalpebralOD.length === 0 &&
                                            isChecked('esclera-od-normal') && escleraOD.length === 0;
            if (allODConjEscleraNormal) {
                odConjEscleraText += 'OD: Conjuntiva y esclera normales. ';
            } else if (conjBulbarOD.length > 0 || conjPalpebralOD.length > 0 || escleraOD.length > 0) {
                externalExamAdded = true;
                odConjEscleraText += 'OD: ';
                if (conjBulbarOD.length > 0) odConjEscleraText += `Conjuntiva bulbar: ${formatList(conjBulbarOD)}. `;
                if (conjPalpebralOD.length > 0) odConjEscleraText += `Conjuntiva palpebral: ${formatList(conjPalpebralOD)}. `;
                if (escleraOD.length > 0) odConjEscleraText += `Esclera: ${formatList(escleraOD)}. `;
            }

            let oiConjEscleraText = '';
            const allOIConjEscleraNormal = isChecked('conjuntiva-bulbar-oi-normal') && conjBulbarOI.length === 0 &&
                                            isChecked('conjuntiva-palpebral-oi-normal') && conjPalpebralOI.length === 0 &&
                                            isChecked('esclera-oi-normal') && escleraOI.length === 0;
            if (allOIConjEscleraNormal) {
                oiConjEscleraText += 'OI: Conjuntiva y esclera normales. ';
            } else if (conjBulbarOI.length > 0 || conjPalpebralOI.length > 0 || escleraOI.length > 0) {
                externalExamAdded = true;
                oiConjEscleraText += 'OI: ';
                if (conjBulbarOI.length > 0) oiConjEscleraText += `Conjuntiva bulbar: ${formatList(conjBulbarOI)}. `;
                if (conjPalpebralOI.length > 0) oiConjEscleraText += `Conjuntiva palpebral: ${formatList(conjPalpebralOI)}. `;
                if (escleraOI.length > 0) oiConjEscleraText += `Esclera: ${formatList(escleraOI)}. `;
            }

            if (odConjEscleraText || oiConjEscleraText) {
                externalExamText += `Conjuntiva y Esclera: ${odConjEscleraText.trim()} ${oiConjEscleraText.trim()}. `;
            }
            

            if (externalExamAdded) {
                conclusion += `EXAMEN EXTERNO DEL OJO:\n${externalExamText.trim()}\n\n`;
            }


            // --- 5. EXAMEN DE MOTILIDAD OCULAR ---
            let motilityAdded = false;
            let motilityText = '';

            // Ducciones
            const duccionesOD = []; ['limitacion-aduccion-od', 'limitacion-abduccion-od', 'limitacion-elevacion-od', 'limitacion-depresion-od'].forEach(id => { if (isChecked(id)) duccionesOD.push(getLabelText(id)); });
            const duccionesOI = []; ['limitacion-aduccion-oi', 'limitacion-abduccion-oi', 'limitacion-elevacion-oi', 'limitacion-depresion-oi'].forEach(id => { if (isChecked(id)) duccionesOI.push(getLabelText(id)); });

            if (duccionesOD.length > 0 || duccionesOI.length > 0 || isChecked('duccion-od-normal') || isChecked('duccion-oi-normal')) {
                motilityAdded = true;
                motilityText += `Ducciones (movimientos monoculares): `;
                if (isChecked('duccion-od-normal') && duccionesOD.length === 0) motilityText += 'OD: Normal. ';
                else if (duccionesOD.length > 0) motilityText += `OD: ${formatList(duccionesOD)}. `;
                if (isChecked('duccion-oi-normal') && duccionesOI.length === 0) motilityText += 'OI: Normal. ';
                else if (duccionesOI.length > 0) motilityText += `OI: ${formatList(duccionesOI)}. `;
            }

            // Versiones
            const versiones = []; ['limitacion-dextroversion', 'limitacion-levoversion', 'limitacion-dextroelevacion', 'limitacion-levoelevacion', 'limitacion-dextrodepresion', 'limitacion-levodepresion'].forEach(id => { if (isChecked(id)) versiones.push(getLabelText(id)); });
            const versionesNormal = isChecked('versiones-normales');
            if (versiones.length > 0 || versionesNormal) {
                motilityAdded = true;
                motilityText += `Versiones (movimientos binoculares): `;
                if (versionesNormal && versiones.length === 0) motilityText += `Normales en todas las direcciones. `;
                else if (versiones.length > 0) motilityText += `Limitaci√≥n en ${formatList(versiones)}. `;
            }

            // Evaluaci√≥n de Diplop√≠a
            const diplopiaPresente = isChecked('diplopia-presente');
            const diplopiaAusente = isChecked('diplopia-ausente');
            const tipoDiplopia = getSelectedText('tipo-diplopia');
            const coverTest = getSelectedText('cover-test');

            if (diplopiaPresente || diplopiaAusente || (tipoDiplopia && tipoDiplopia !== 'seleccionar') || (coverTest && coverTest !== 'seleccionar')) {
                motilityAdded = true;
                motilityText += `Evaluaci√≥n de Diplop√≠a: `;
                if (diplopiaPresente) motilityText += `Diplop√≠a presente. `;
                else if (diplopiaAusente) motilityText += `Diplop√≠a ausente. `;
                if (tipoDiplopia && tipoDiplopia !== 'seleccionar') motilityText += `Tipo: ${tipoDiplopia}. `;
                if (coverTest && coverTest !== 'seleccionar') motilityText += `Cover Test: ${coverTest}. `;
            }

            // Nistagmo
            const nistagmoPresente = isChecked('nistagmo-presente');
            const nistagmoAusente = isChecked('nistagmo-ausente');
            const direccionNistagmo = getSelectedText('direccion-nistagmo');

            if (nistagmoPresente || nistagmoAusente || (direccionNistagmo && direccionNistagmo !== 'seleccionar')) {
                motilityAdded = true;
                motilityText += `Nistagmo: `;
                if (nistagmoPresente) motilityText += `Nistagmo espont√°neo presente. `;
                else if (nistagmoAusente) motilityText += `Nistagmo espont√°neo ausente. `;
                if (direccionNistagmo && direccionNistagmo !== 'seleccionar') motilityText += `Direcci√≥n: ${direccionNistagmo}. `;
            }

            if (motilityAdded) {
                conclusion += `EXAMEN DE MOTILIDAD OCULAR:\n${motilityText.trim()}\n\n`;
            }

            // --- 6. EXAMEN DEL SEGMENTO ANTERIOR ---
            let anteriorSegmentAdded = false;
            let anteriorSegmentText = '';

            // C√≥rnea
            const corneaODTransparente = isChecked('cornea-od-transparente');
            const corneaODHallazgos = [];
            ['cornea-od-edema', 'cornea-od-leucoma', 'cornea-od-abrasion', 'cornea-od-ulcera',
             'cornea-od-precipitados', 'cornea-od-neovascularizacion', 'cornea-od-degeneracion'].forEach(id => { if (isChecked(id)) corneaODHallazgos.push(getLabelText(id)); });
            const fluoresceinaODPos = isChecked('fluoresceina-od-pos');
            const fluoresceinaODNeg = isChecked('fluoresceina-od-neg');

            const corneaOITransparente = isChecked('cornea-oi-transparente');
            const corneaOIHallazgos = [];
            ['cornea-oi-edema', 'cornea-oi-leucoma', 'cornea-oi-abrasion', 'cornea-oi-ulcera',
             'cornea-oi-precipitados', 'cornea-oi-neovascularizacion', 'cornea-oi-degeneracion'].forEach(id => { if (isChecked(id)) corneaOIHallazgos.push(getLabelText(id)); });
            const fluoresceinaOIPos = isChecked('fluoresceina-oi-pos');
            const fluoresceinaOINeg = isChecked('fluoresceina-oi-neg');

            if (corneaODHallazgos.length > 0 || corneaODTransparente || fluoresceinaODPos || fluoresceinaODNeg ||
                corneaOIHallazgos.length > 0 || corneaOITransparente || fluoresceinaOIPos || fluoresceinaOINeg) {
                anteriorSegmentAdded = true;
                anteriorSegmentText += `C√≥rnea: `;
                if (corneaODTransparente && corneaODHallazgos.length === 0) anteriorSegmentText += 'OD: Transparente. ';
                else if (corneaODHallazgos.length > 0) anteriorSegmentText += `OD: ${formatList(corneaODHallazgos)}. `;
                if (fluoresceinaODPos) anteriorSegmentText += `Fluoresce√≠na OD: Positiva. `;
                else if (fluoresceinaODNeg) anteriorSegmentText += `Fluoresce√≠na OD: Negativa. `;

                if (corneaOITransparente && corneaOIHallazgos.length === 0) anteriorSegmentText += 'OI: Transparente. ';
                else if (corneaOIHallazgos.length > 0) anteriorSegmentText += `OI: ${formatList(corneaOIHallazgos)}. `;
                if (fluoresceinaOIPos) anteriorSegmentText += `Fluoresce√≠na OI: Positiva. `;
                else if (fluoresceinaOINeg) anteriorSegmentText += `Fluoresce√≠na OI: Negativa. `;
            }

            // C√°mara Anterior e Iris
            const camaraAnteriorOD = []; ['camara-anterior-od-estrecha', 'camara-anterior-od-profunda', 'hipopion-od', 'hifema-od', 'celulas-od', 'flare-od'].forEach(id => { if (isChecked(id)) camaraAnteriorOD.push(getLabelText(id)); });
            const irisOD = []; ['sinequias-anteriores-od', 'sinequias-posteriores-od', 'atrofia-iris-od', 'nodulos-iris-od', 'neovascularizacion-iris-od'].forEach(id => { if (isChecked(id)) irisOD.push(getLabelText(id)); });

            const camaraAnteriorOI = []; ['camara-anterior-oi-estrecha', 'camara-anterior-oi-profunda', 'hipopion-oi', 'hifema-oi', 'celulas-oi', 'flare-oi'].forEach(id => { if (isChecked(id)) camaraAnteriorOI.push(getLabelText(id)); });
            const irisOI = []; ['sinequias-anteriores-oi', 'sinequias-posteriores-oi', 'atrofia-iris-oi', 'nodulos-iris-oi', 'neovascularizacion-iris-oi'].forEach(id => { if (isChecked(id)) irisOI.push(getLabelText(id)); });

            if (camaraAnteriorOD.length > 0 || irisOD.length > 0 || isChecked('camara-anterior-od-normal') || isChecked('iris-od-normal') ||
                camaraAnteriorOI.length > 0 || irisOI.length > 0 || isChecked('camara-anterior-oi-normal') || isChecked('iris-oi-normal')) {
                anteriorSegmentAdded = true;
                anteriorSegmentText += `C√°mara Anterior e Iris: `;
                if (isChecked('camara-anterior-od-normal') && camaraAnteriorOD.length === 0) anteriorSegmentText += 'OD: CA normal. ';
                else if (camaraAnteriorOD.length > 0) anteriorSegmentText += `OD CA: ${formatList(camaraAnteriorOD)}. `;
                if (isChecked('iris-od-normal') && irisOD.length === 0) anteriorSegmentText += 'OD Iris: Normal. ';
                else if (irisOD.length > 0) anteriorSegmentText += `OD Iris: ${formatList(irisOD)}. `;

                if (isChecked('camara-anterior-oi-normal') && camaraAnteriorOI.length === 0) anteriorSegmentText += 'OI: CA normal. ';
                else if (camaraAnteriorOI.length > 0) anteriorSegmentText += `OI CA: ${formatList(camaraAnteriorOI)}. `;
                if (isChecked('iris-oi-normal') && irisOI.length === 0) anteriorSegmentText += 'OI Iris: Normal. ';
                else if (irisOI.length > 0) anteriorSegmentText += `OI Iris: ${formatList(irisOI)}. `;
            }

            // Cristalino
            const cristalinoODTransparente = isChecked('cristalino-od-transparente');
            const cristalinoODHallazgos = [];
            ['catarata-nuclear-od', 'catarata-cortical-od', 'catarata-subcapsular-od', 'catarata-madura-od', 'pseudofaco-od', 'afaco-od'].forEach(id => { if (isChecked(id)) cristalinoODHallazgos.push(getLabelText(id)); });
            const catNuclearODGrado = getSelectedValue('catarata-nuclear-grado-od');
            const catCorticalODGrado = getSelectedValue('catarata-cortical-grado-od');
            const catSubcapsularODGrado = getSelectedValue('catarata-subcapsular-grado-od');

            const cristalinoOITransparente = isChecked('cristalino-oi-transparente');
            const cristalinoOIHallazgos = [];
            ['catarata-nuclear-oi', 'catarata-cortical-oi', 'catarata-subcapsular-oi', 'catarata-madura-oi', 'pseudofaco-oi', 'afaco-oi'].forEach(id => { if (isChecked(id)) cristalinoOIHallazgos.push(getLabelText(id)); });
            const catNuclearOIGrado = getSelectedValue('catarata-nuclear-grado-oi');
            const catCorticalOIGrado = getSelectedValue('catarata-cortical-grado-oi');
            const catSubcapsularOIGrado = getSelectedValue('catarata-subcapsular-grado-oi');

            if (cristalinoODHallazgos.length > 0 || cristalinoODTransparente || catNuclearODGrado || catCorticalODGrado || catSubcapsularODGrado ||
                cristalinoOIHallazgos.length > 0 || cristalinoOITransparente || catNuclearOIGrado || catCorticalOIGrado || catSubcapsularOIGrado) {
                anteriorSegmentAdded = true;
                anteriorSegmentText += `Cristalino: `;
                if (cristalinoODTransparente && cristalinoODHallazgos.length === 0) anteriorSegmentText += 'OD: Transparente. ';
                else if (cristalinoODHallazgos.length > 0) anteriorSegmentText += `OD: ${formatList(cristalinoODHallazgos)}. `;
                if (catNuclearODGrado || catCorticalODGrado || catSubcapsularODGrado) {
                    anteriorSegmentText += `Grado (LOCS III) - Nuclear: ${catNuclearODGrado || 'N/A'}, Cortical: ${catCorticalODGrado || 'N/A'}, Subcapsular: ${catSubcapsularODGrado || 'N/A'}. `;
                }

                if (cristalinoOITransparente && cristalinoOIHallazgos.length === 0) anteriorSegmentText += 'OI: Transparente. ';
                else if (cristalinoOIHallazgos.length > 0) anteriorSegmentText += `OI: ${formatList(cristalinoOIHallazgos)}. `;
                if (catNuclearOIGrado || catCorticalOIGrado || catSubcapsularOIGrado) {
                    anteriorSegmentText += `Grado (LOCS III) - Nuclear: ${catNuclearOIGrado || 'N/A'}, Cortical: ${catCorticalOIGrado || 'N/A'}, Subcapsular: ${catSubcapsularOIGrado || 'N/A'}. `;
                }
            }


            if (anteriorSegmentAdded) {
                conclusion += `EXAMEN DEL SEGMENTO ANTERIOR:\n${anteriorSegmentText.trim()}\n\n`;
            }

            // --- 7. PRESI√ìN INTRAOCULAR Y GLAUCOMA ---
            let pioAdded = false;
            let pioText = '';

            const pioOD = getInputValue('pio-od');
            const horaPIOOD = getInputValue('hora-pio-od');
            const metodoPIOOD = getRadioButtonValue('metodo-pio-od');
            const interpretacionPIOOD = document.getElementById('interpretacion-pio-od').textContent;

            const pioOI = getInputValue('pio-oi');
            const horaPIOOI = getInputValue('hora-pio-oi');
            const metodoPIOOI = getRadioButtonValue('metodo-pio-oi');
            const interpretacionPIOOI = document.getElementById('interpretacion-pio-oi').textContent;

            if (pioOD || pioOI) {
                pioAdded = true;
                pioText += `Medici√≥n de Presi√≥n Intraocular (PIO): `;
                if (pioOD) {
                    pioText += `OD: ${pioOD} mmHg (${interpretacionPIOOD})${horaPIOOD ? ` a las ${horaPIOOD}` : ''}${metodoPIOOD ? ` por ${metodoPIOOD}` : ''}. `;
                } else if (metodoPIOOD || horaPIOOD) { // Si hay m√©todo/hora pero no PIO
                     pioText += `OD: Sin valor de PIO, ${horaPIOOD ? `medido a las ${horaPIOOD}` : ''}${metodoPIOOD ? ` por ${metodoPIOOD}` : ''}. `;
                }
                if (pioOI) {
                    pioText += `OI: ${pioOI} mmHg (${interpretacionPIOOI})${horaPIOOI ? ` a las ${horaPIOOI}` : ''}${metodoPIOOI ? ` por ${metodoPIOOI}` : ''}. `;
                } else if (metodoPIOOI || horaPIOOI) { // Si hay m√©todo/hora pero no PIO
                     pioText += `OI: Sin valor de PIO, ${horaPIOOI ? `medido a las ${horaPIOOI}` : ''}${metodoPIOOI ? ` por ${metodoPIOOI}` : ''}. `;
                }
            }

            const factoresRiesgoGlaucoma = [];
            ['antecedente-familiar-glaucoma', 'edad-mayor-40', 'raza-afroamericana', 'miopia-alta-glaucoma',
             'diabetes-glaucoma', 'uso-corticoides', 'trauma-ocular-previo'].forEach(id => {
                if (isChecked(id)) factoresRiesgoGlaucoma.push(getLabelText(id));
            });
            if (factoresRiesgoGlaucoma.length > 0) {
                pioAdded = true;
                pioText += `Factores de riesgo para glaucoma: ${formatList(factoresRiesgoGlaucoma)}. `;
            }

            if (pioAdded) {
                conclusion += `PRESI√ìN INTRAOCULAR Y GLAUCOMA:\n${pioText.trim()}\n\n`;
            }

            // --- 8. FUNDOSCOP√çA Y SEGMENTO POSTERIOR ---
            let fundoscopyAdded = false;
            let fundoscopyText = '';

            // Disco √ìptico OD
            const discoODNormal = isChecked('disco-od-normal');
            const discoODHallazgos = [];
            ['papiledema-od', 'atrofia-optica-od', 'excavacion-aumentada-od', 'hemorragias-disco-od', 'drusas-disco-od', 'neovascularizacion-disco-od'].forEach(id => {
                if (isChecked(id)) discoODHallazgos.push(getLabelText(id));
            });
            const cupDiscOD = getInputValue('cup-disc-od');
            const interpretacionCDOD = document.getElementById('interpretacion-cd-od').textContent;

            // Disco √ìptico OI
            const discoOINormal = isChecked('disco-oi-normal');
            const discoOIHallazgos = [];
            ['papiledema-oi', 'atrofia-optica-oi', 'excavacion-aumentada-oi', 'hemorragias-disco-oi', 'drusas-disco-oi', 'neovascularizacion-disco-oi'].forEach(id => {
                if (isChecked(id)) discoOIHallazgos.push(getLabelText(id));
            });
            const cupDiscOI = getInputValue('cup-disc-oi');
            const interpretacionCDOI = document.getElementById('interpretacion-cd-oi').textContent;
            
            if (discoODHallazgos.length > 0 || discoODNormal || cupDiscOD || discoOIHallazgos.length > 0 || discoOINormal || cupDiscOI) {
                fundoscopyAdded = true;
                fundoscopyText += `Disco √ìptico: `;
                if (discoODNormal && discoODHallazgos.length === 0) fundoscopyText += 'OD: Aspecto normal. ';
                else if (discoODHallazgos.length > 0) fundoscopyText += `OD: ${formatList(discoODHallazgos)}. `;
                if (cupDiscOD) fundoscopyText += `Relaci√≥n copa/disco OD: ${cupDiscOD} (${interpretacionCDOD}). `;

                if (discoOINormal && discoOIHallazgos.length === 0) fundoscopyText += 'OI: Aspecto normal. ';
                else if (discoOIHallazgos.length > 0) fundoscopyText += `OI: ${formatList(discoOIHallazgos)}. `;
                if (cupDiscOI) fundoscopyText += `Relaci√≥n copa/disco OI: ${cupDiscOI} (${interpretacionCDOI}). `;
            }

            // M√°cula OD
            const maculaODNormal = isChecked('macula-od-normal');
            const maculaODHallazgos = [];
            ['drusas-od', 'degeneracion-macular-od', 'edema-macular-od', 'hemorragias-maculares-od',
             'exudados-duros-od', 'exudados-blandos-od', 'neovascularizacion-macular-od',
             'agujero-macular-od', 'membrana-epirretiniana-od'].forEach(id => { if (isChecked(id)) maculaODHallazgos.push(getLabelText(id)); });

            // M√°cula OI
            const maculaOINormal = isChecked('macula-oi-normal');
            const maculaOIHallazgos = [];
            ['drusas-oi', 'degeneracion-macular-oi', 'edema-macular-oi', 'hemorragias-maculares-oi',
             'exudados-duros-oi', 'exudados-blandos-oi', 'neovascularizacion-macular-oi',
             'agujero-macular-oi', 'membrana-epirretiniana-oi'].forEach(id => { if (isChecked(id)) maculaOIHallazgos.push(getLabelText(id)); });

            if (maculaODHallazgos.length > 0 || maculaODNormal || maculaOIHallazgos.length > 0 || maculaOINormal) {
                fundoscopyAdded = true;
                fundoscopyText += `M√°cula: `;
                if (maculaODNormal && maculaODHallazgos.length === 0) fundoscopyText += 'OD: Aspecto normal. ';
                else if (maculaODHallazgos.length > 0) fundoscopyText += `OD: ${formatList(maculaODHallazgos)}. `;

                if (maculaOINormal && maculaOIHallazgos.length === 0) fundoscopyText += 'OI: Aspecto normal. ';
                else if (maculaOIHallazgos.length > 0) fundoscopyText += `OI: ${formatList(maculaOIHallazgos)}. `;
            }

            // Retina Perif√©rica y Vasos OD
            const vasosODNormales = isChecked('vasos-od-normales');
            const vasosODHallazgos = [];
            ['estrechamiento-arteriolar-od', 'cruces-av-patologicos-od', 'hemorragias-retinianas-od', 'microaneurismas-od', 'manchas-algodonosas-od', 'neovascularizacion-retiniana-od'].forEach(id => { if (isChecked(id)) vasosODHallazgos.push(getLabelText(id)); });
            const retinaPerifericaODNormal = isChecked('retina-periferica-od-normal');
            const retinaPerifericaODHallazgos = [];
            ['desgarros-retinianos-od', 'desprendimiento-retina-od', 'degeneracion-lattice-od', 'cicatrices-laser-od'].forEach(id => { if (isChecked(id)) retinaPerifericaODHallazgos.push(getLabelText(id)); });

            // Retina Perif√©rica y Vasos OI
            const vasosOINormales = isChecked('vasos-oi-normales');
            const vasosOIHallazgos = [];
            ['estrechamiento-arteriolar-oi', 'cruces-av-patologicos-oi', 'hemorragias-retinianas-oi', 'microaneurismas-oi', 'manchas-algodonosas-oi', 'neovascularizacion-retiniana-oi'].forEach(id => { if (isChecked(id)) vasosOIHallazgos.push(getLabelText(id)); });
            const retinaPerifericaOINormal = isChecked('retina-periferica-oi-normal');
            const retinaPerifericaOIHallazgos = [];
            ['desgarros-retinianos-oi', 'desprendimiento-retina-oi', 'degeneracion-lattice-oi', 'cicatrices-laser-oi'].forEach(id => { if (isChecked(id)) retinaPerifericaOIHallazgos.push(getLabelText(id)); });

            if (vasosODHallazgos.length > 0 || vasosODNormales || retinaPerifericaODHallazgos.length > 0 || retinaPerifericaODNormal ||
                vasosOIHallazgos.length > 0 || vasosOINormales || retinaPerifericaOIHallazgos.length > 0 || retinaPerifericaOINormal) {
                fundoscopyAdded = true;
                fundoscopyText += `Retina Perif√©rica y Vasos: `;
                if (vasosODNormales && vasosODHallazgos.length === 0) fundoscopyText += 'OD vasos: Normales. ';
                else if (vasosODHallazgos.length > 0) fundoscopyText += `OD vasos: ${formatList(vasosODHallazgos)}. `;
                if (retinaPerifericaODNormal && retinaPerifericaODHallazgos.length === 0) fundoscopyText += 'OD retina perif√©rica: Normal. ';
                else if (retinaPerifericaODHallazgos.length > 0) fundoscopyText += `OD retina perif√©rica: ${formatList(retinaPerifericaODHallazgos)}. `;

                if (vasosOINormales && vasosOIHallazgos.length === 0) fundoscopyText += 'OI vasos: Normales. ';
                else if (vasosOIHallazgos.length > 0) fundoscopyText += `OI vasos: ${formatList(vasosOIHallazgos)}. `;
                if (retinaPerifericaOINormal && retinaPerifericaOIHallazgos.length === 0) fundoscopyText += 'OI retina perif√©rica: Normal. ';
                else if (retinaPerifericaOIHallazgos.length > 0) fundoscopyText += `OI retina perif√©rica: ${formatList(retinaPerifericaOIHallazgos)}. `;
            }

            // V√≠treo OD
            const vitreoODTransparente = isChecked('vitreo-od-transparente');
            const vitreoODHallazgos = [];
            ['hemorragia-vitrea-od', 'opacidades-vitreas-od', 'desprendimiento-vitreo-od', 'proliferacion-vitreorretiniana-od', 'celulas-vitreas-od'].forEach(id => { if (isChecked(id)) vitreoODHallazgos.push(getLabelText(id)); });

            // V√≠treo OI
            const vitreoOITransparente = isChecked('vitreo-oi-transparente');
            const vitreoOIHallazgos = [];
            ['hemorragia-vitrea-oi', 'opacidades-vitreas-oi', 'desprendimiento-vitreo-oi', 'proliferacion-vitreorretiniana-oi', 'celulas-vitreas-oi'].forEach(id => { if (isChecked(id)) vitreoOIHallazgos.push(getLabelText(id)); });

            if (vitreoODHallazgos.length > 0 || vitreoODTransparente || vitreoOIHallazgos.length > 0 || vitreoOITransparente) {
                fundoscopyAdded = true;
                fundoscopyText += `V√≠treo: `;
                if (vitreoODTransparente && vitreoODHallazgos.length === 0) fundoscopyText += 'OD: Transparente. ';
                else if (vitreoODHallazgos.length > 0) fundoscopyText += `OD: ${formatList(vitreoODHallazgos)}. `;

                if (vitreoOITransparente && vitreoOIHallazgos.length === 0) fundoscopyText += 'OI: Transparente. ';
                else if (vitreoOIHallazgos.length > 0) fundoscopyText += `OI: ${formatList(vitreoOIHallazgos)}. `;
            }


            if (fundoscopyAdded) {
                conclusion += `FUNDOSCOP√çA Y SEGMENTO POSTERIOR:\n${fundoscopyText.trim()}\n\n`;
            }

            // --- 9. ESCALAS DE EVALUACI√ìN OFTALMOL√ìGICA ---
            let scalesAdded = false;
            let scalesText = '';

            // Clasificaci√≥n de Retinopat√≠a Diab√©tica (ETDRS)
            const retinopatiaDiabetica = getRadioButtonValue('retinopatia-diabetica');
            if (retinopatiaDiabetica) {
                scalesAdded = true;
                scalesText += `Retinopat√≠a Diab√©tica (ETDRS): ${capitalizeFirstLetter(retinopatiaDiabetica)}. `;
            }

            // Clasificaci√≥n de Retinopat√≠a Hipertensiva (Keith-Wagener-Barker)
            const retinopatiaHipertensiva = getRadioButtonValue('retinopatia-hipertensiva');
            if (retinopatiaHipertensiva) {
                scalesAdded = true;
                scalesText += `Retinopat√≠a Hipertensiva (Keith-Wagener-Barker): ${capitalizeFirstLetter(retinopatiaHipertensiva)}. `;
            }

            // Clasificaci√≥n de Degeneraci√≥n Macular Relacionada con la Edad (AREDS)
            const dmreAreds = getRadioButtonValue('dmre-areds');
            if (dmreAreds) {
                scalesAdded = true;
                scalesText += `Degeneraci√≥n Macular Relacionada con la Edad (AREDS): ${capitalizeFirstLetter(dmreAreds)}. `;
            }

            // Evaluaci√≥n de Discapacidad Visual (OMS)
            const mejorOjoAV = getInputValue('mejor-ojo-av');
            const clasificacionOMS = document.getElementById('clasificacion-oms').textContent;
            if (mejorOjoAV || (clasificacionOMS && clasificacionOMS !== '--')) {
                scalesAdded = true;
                scalesText += `Discapacidad Visual (OMS): Mejor ojo AV: ${mejorOjoAV || 'No especificado'}. Clasificaci√≥n: ${clasificacionOMS}. `;
            }

            // Cuestionario VFQ-25 (Funci√≥n Visual)
            const vfqScore = document.getElementById('vfq-score').textContent;
            const vfqItemsChecked = [
                'vfq-vision-general', 'vfq-actividades-cerca', 'vfq-actividades-lejos',
                'vfq-vision-social', 'vfq-salud-mental', 'vfq-dependencia',
                'vfq-conducir', 'vfq-color', 'vfq-vision-periferica'
            ].some(id => isChecked(id));

            if (vfqScore !== '0' || vfqItemsChecked) {
                scalesAdded = true;
                scalesText += `Cuestionario VFQ-25 (Funci√≥n Visual): ${vfqScore}/9 √°reas afectadas. `;
                if (vfqItemsChecked) {
                    const affectedAreas = [];
                    [
                        'vfq-vision-general', 'vfq-actividades-cerca', 'vfq-actividades-lejos',
                        'vfq-vision-social', 'vfq-salud-mental', 'vfq-dependencia',
                        'vfq-conducir', 'vfq-color', 'vfq-vision-periferica'
                    ].forEach(id => {
                        if (isChecked(id)) affectedAreas.push(getLabelText(id));
                    });
                    if (affectedAreas.length > 0) {
                        scalesText += `√Åreas afectadas: ${formatList(affectedAreas)}. `;
                    }
                }
            }

            if (scalesAdded) {
                conclusion += `ESCALAS DE EVALUACI√ìN OFTALMOL√ìGICA:\n${scalesText.trim()}\n\n`;
            }

            // --- CONCLUSI√ìN FINAL Y PLAN ---
            if (conclusion.trim() === 'INFORME DEL EXAMEN OFTALMOL√ìGICO:') {
                conclusion = 'Seleccione los par√°metros del examen para generar la conclusi√≥n oftalmol√≥gica...';
            } else {
                conclusion += 'RESUMEN Y CONCLUSI√ìN:\n';
                if (alertCount > 0) {
                    conclusion += `Se identifican ${alertCount} **alertas cr√≠ticas** que requieren atenci√≥n inmediata. `;
                }
                if (warningCount > 0) {
                    conclusion += `Existen ${warningCount} **hallazgos importantes** que deben ser considerados. `;
                }
                if (findingsCount > 0) {
                    conclusion += `Un total de ${findingsCount} hallazgos relevantes han sido registrados en este examen. `;
                } else {
                    conclusion += `El examen no ha revelado hallazgos significativos. `;
                }
                conclusion += '\n\n';

                conclusion += 'IMPRESI√ìN DIAGN√ìSTICA:\n';
                conclusion += '[Correlacionar hallazgos con historia cl√≠nica completa, antecedentes familiares y sist√©micos, y resultados de pruebas complementarias (OCT, campimetr√≠a, angiograf√≠a, etc.).]\n\n';
                conclusion += 'PLAN DE MANEJO:\n';
                conclusion += '[El plan de manejo se adaptar√° a la impresi√≥n diagn√≥stica, considerando la gravedad, progresi√≥n y las opciones terap√©uticas disponibles. Puede incluir observaci√≥n, manejo farmacol√≥gico, terapia l√°ser o intervenci√≥n quir√∫rgica.]\n\n';
                conclusion += 'SEGUIMIENTO:\n';
                conclusion += '[Se recomienda seguimiento oftalmol√≥gico peri√≥dico seg√∫n la patolog√≠a diagnosticada y las necesidades individuales del paciente, para monitorear la progresi√≥n de la enfermedad y ajustar el tratamiento.]\n\n';
                conclusion += `COMPLETITUD DEL EXAMEN: ${examProgress}%`;
            }

            conclusionEl.textContent = conclusion;
            
            // Actualizar panel sticky si est√° activo
            const stickyPanel = document.getElementById('stickyConclusion');
            if (stickyPanel && stickyPanel.classList.contains('active')) {
                // Peque√±o retardo para asegurar que el DOM se actualice antes de copiar
                setTimeout(() => generateStickyConclusion(), 100); 
            }
        }

        function printConclusion() {
            const conclusion = document.getElementById('conclusion-text').textContent;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Conclusi√≥n Examen Oftalmol√≥gico</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            line-height: 1.6;
                        }
                        pre { 
                            white-space: pre-wrap; 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid var(--primary-color);
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        .footer {
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                            margin-top: 20px;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Examen Oftalmol√≥gico - Conclusi√≥n</h1>
                        <p>Fecha: ${new Date().toLocaleDateString()}</p>
                    </div>
                    <pre>${conclusion}</pre>
                    <div class="footer">
                        <p>Generado por Sistema de Evaluaci√≥n Oftalmol√≥gica</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function clearForm() {
            if (confirm('¬øEst√° seguro de que desea limpiar todos los datos del formulario?')) {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.disabled = false; // Re-habilitar
                    cb.style.backgroundColor = ''; // Quitar resaltado
                    cb.style.border = ''; // Quitar resaltado
                });
                document.querySelectorAll('input[type="radio"]').forEach(rb => rb.checked = false);
                document.querySelectorAll('input[type="number"]').forEach(nb => nb.value = '');
                document.querySelectorAll('input[type="text"]').forEach(tb => tb.value = '');
                document.querySelectorAll('input[type="time"]').forEach(tb => tb.value = '');
                document.querySelectorAll('input[type="range"]').forEach(rb => rb.value = 0);
                document.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
                document.querySelectorAll('textarea').forEach(ta => ta.value = '');
                
                // Resetear valores espec√≠ficos de dashboards y elementos visuales
                document.getElementById('dolor-od-value').textContent = '0';
                document.getElementById('dolor-oi-value').textContent = '0';
                document.getElementById('interpretacion-pio-od').textContent = '--';
                document.getElementById('interpretacion-pio-oi').textContent = '--';
                document.getElementById('interpretacion-cd-od').textContent = '--';
                document.getElementById('interpretacion-cd-oi').textContent = '--';
                document.getElementById('clasificacion-oms').textContent = '--';
                document.getElementById('vfq-score').textContent = '0';
                
                // Limpiar defectos de campo visual
                document.querySelectorAll('.field-quadrant.defect').forEach(quad => {
                    quad.classList.remove('defect');
                });
                
                // Ocultar secciones condicionales
                document.getElementById('pain-characteristics-section').classList.add('hidden');
                
                // Quitar resaltados de factores de riesgo
                document.querySelectorAll('.warning-highlight').forEach(el => el.classList.remove('warning-highlight'));
                document.querySelectorAll('[style*="border-color: var(--warning-color)"], [style*="box-shadow: 0 0 5px rgba(243, 156, 18, 0.5)"], [style*="background-color: rgb(255, 243, 205)"]').forEach(el => {
                    el.style.borderColor = '';
                    el.style.boxShadow = '';
                    el.style.backgroundColor = '';
                });

                // Resetear clases de PIO en el score-calculation
                const pioScoreCalc = document.querySelector('#pressure-exam .score-calculation');
                pioScoreCalc.classList.remove('pio-normal', 'pio-borderline', 'pio-elevated', 'pio-very-elevated');
                
                // Re-inicializar estado de las variables del dashboard
                avODStatus = '--';
                avOIStatus = '--';
                pioODStatus = '--';
                pioOIStatus = '--';

                // Recalcular y generar conclusi√≥n
                updateDashboard();
                generateConclusion();
            }
        }
        
        // üöÄ Inicializaci√≥n del sistema
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar tema guardado
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }

            // Event listeners para actualizar dashboard y conclusi√≥n
            document.querySelectorAll('input, select, textarea').forEach(el => {
                // Eliminar cualquier listener previo para evitar duplicados si la p√°gina se carga varias veces
                el.removeEventListener('change', updateDashboard);
                el.removeEventListener('input', updateDashboard);
                el.removeEventListener('change', generateConclusion);
                el.removeEventListener('input', generateConclusion);

                // A√±adir los listeners
                el.addEventListener('change', () => {
                    updateDashboard();
                    generateConclusion(); // Llama a generateConclusion en cada cambio para el informe en tiempo real
                });
                el.addEventListener('input', () => { // Usar 'input' para rangos y n√∫meros en tiempo real
                    if (el.type === 'range' || el.type === 'number' || el.type === 'text') {
                        updateDashboard();
                        generateConclusion();
                    }
                });
            });
             
            // Actualizar altura de secciones al cambiar contenido
            document.querySelector('.main-container').addEventListener('change', (event) => {
                const sectionContent = event.target.closest('.section-content.expanded');
                if (sectionContent) {
                    updateSectionHeight(sectionContent);
                }
            });
            document.querySelector('.main-container').addEventListener('input', (event) => { // Tambi√©n para inputs continuos
                const sectionContent = event.target.closest('.section-content.expanded');
                if (sectionContent) {
                    updateSectionHeight(sectionContent);
                }
            });
             
            // Expandir la primera secci√≥n por defecto
            const firstSectionHeader = document.querySelector('.section-header');
            if (firstSectionHeader && !firstSectionHeader.classList.contains('expanded')) {
                toggleSection(firstSectionHeader);
            }
            
            // Inicializar evaluaciones de escalas y estados del dashboard
            evaluatePIO();
            evaluateAVStatus('od');
            evaluateAVStatus('oi');
            evaluateCupDisc('od');
            evaluateCupDisc('oi');
            calculateVisualDisability();
            calculateVFQ();
            
            // Asegurarse de que los resaltados de antecedentes est√©n correctos al cargar
            updateGlaucomaHighlights(document.getElementById('glaucoma-familiar'));
            updateDiabetesHighlights(document.getElementById('diabetes'));
            updateHypertensionHighlights(document.getElementById('hipertension'));
            handlePainComplaint(document.getElementById('dolor-ocular')); // Ocultar/mostrar secci√≥n de dolor seg√∫n el checkbox

            updateDashboard(); // Una √∫ltima actualizaci√≥n del dashboard al cargar
            generateConclusion(); // Generar la conclusi√≥n inicial
            
            // Mostrar mensaje de bienvenida
            setTimeout(() => {
                console.log('üéâ Sistema de Evaluaci√≥n Oftalmol√≥gica Premium con Panel Sticky cargado exitosamente!');
            }, 1000);
        });
    </script>
</body>
</html>
                                        